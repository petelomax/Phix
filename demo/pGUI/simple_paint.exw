--
-- simple_paint.exw
--
--  Translated from simple_paint.c (included in the distribution for comparison)
--
--  NB not yet very well tested.
--  BUG: [FIXED] does not work on 64-bit (I need to get an ex.err out of 64-bit Phix before doing anything else about that)
--  BUG: picture vanishes when zooming in too far on 64-bit..
--  BUG: [FIXED] statusbar not visible initially, but menu entry for it checked. (it should be visible and menu entry is then fine)
--  BUG: [FIXED] as shown in the statusbar, it does not manage to retrieve RGB values under the cursor. [im_pixel added]
--
--   Possible Enhancements (as copied from the C original): 
--     - Save last used toolbox options in configuration file?
--     - Hide/show toolbox options according to selected tool
--     - Capture image from Camera using IM
--     - Undo/Redo
--     - Secondary color for drawing of shapes with both outline and filled at the same time
--     - Alpha for colors
--     - Area Selection

include pGUI.e

-- For Edita/Tools/Re-indent source:
--#withtype Ihandle
--#withtype Ihandln
--#withtype imImage
--#withtype cdCanvas
--#withtype cdCanvan

Ihandle dlg, canvas, toolbar, statusbar, main_menu, zoom_lbl, size_lbl, status_lbl, zoom_val,
        item_toolbar, item_statusbar, item_revert, item_save, item_paste, item_zoomgrid, item_toolbox,
        filltol_label, toolcolor_btn, toolwidth_txt, toolstyle_lst, toolfont_btn, filltol_val
Ihandln config, toolbox=NULL
Ihandle clipboard

--imImage image=NULL    -- (this was a step too far, not really needed/useful anyway)

--constant USE_OPENGL = 01
constant USE_CONTEXTPLUS = 0    -- (not working [on Windows])

--/********************************** Images *****************************************/

function load_image_PaintLine()
sequence imgdata =
{
 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 0, 0, 0, 2, 0, 0, 0, 5, 0, 0, 0, 12, 0, 0, 0, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 0, 0, 0, 0, 0, 0, 0, 13, 0, 0, 0, 239, 0, 0, 0, 60, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 84, 0, 0, 0, 239, 0, 0, 0, 60, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 84, 0, 0, 0, 239, 0, 0, 0, 60, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 84, 0, 0, 0, 239, 0, 0, 0, 60, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 84, 0, 0, 0, 239, 0, 0, 0, 60, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 84, 0, 0, 0, 239, 0, 0, 0, 60, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 84, 0, 0, 0, 239, 0, 0, 0, 60, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 84, 0, 0, 0, 239, 0, 0, 0, 60, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 84, 0, 0, 0, 239, 0, 0, 0, 60, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 84, 0, 0, 0, 239, 0, 0, 0, 60, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 84, 0, 0, 0, 239, 0, 0, 0, 60, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 84, 0, 0, 0, 227, 0, 0, 0, 8, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 16, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0}

Ihandle image = IupImageRGBA(16, 16, imgdata)
    return image
end function

function load_image_Pointer()
sequence imgdata =
{
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 162, 180, 203, 255, 162, 180, 203, 84, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 162, 180, 203, 255, 162, 180, 203, 255, 162, 180, 203, 84, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 162, 180, 203, 255, 240, 243, 246, 255, 162, 180, 203, 255, 162, 180, 203, 69, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 162, 180, 203, 255, 255, 255, 255, 255, 241, 244, 247, 255, 161, 179, 202, 255, 161, 179, 202, 57, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 158, 176, 200, 255, 255, 255, 255, 255, 255, 255, 255, 255, 240, 242, 246, 255, 147, 165, 189, 255, 134, 152, 176, 57, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 153, 172, 195, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 227, 231, 236, 255, 129, 147, 171, 255, 115, 134, 158, 48, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 148, 166, 189, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 253, 253, 254, 255, 213, 218, 226, 255, 111, 130, 154, 255, 96, 115, 140, 57, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 141, 159, 183, 255, 254, 255, 255, 255, 252, 253, 254, 255, 250, 251, 253, 255, 247, 248, 251, 255, 243, 246, 250, 255, 206, 213, 223, 255, 91, 110, 136, 255, 73, 92, 118, 48, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 134, 152, 176, 255, 249, 250, 252, 255, 246, 247, 251, 255, 242, 245, 249, 255, 238, 242, 247, 255, 92, 111, 137, 255, 56, 76, 102, 255, 60, 80, 106, 255, 73, 92, 118, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 127, 145, 170, 255, 241, 244, 249, 255, 205, 212, 221, 255, 88, 108, 133, 255, 229, 234, 243, 255, 105, 124, 148, 255, 105, 124, 148, 83, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 119, 138, 163, 255, 203, 209, 220, 255, 63, 83, 109, 255, 102, 121, 145, 255, 197, 206, 221, 255, 187, 197, 214, 255, 89, 108, 133, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 112, 131, 156, 255, 82, 101, 127, 255, 55, 75, 101, 81, 102, 121, 145, 123, 102, 121, 145, 255, 206, 215, 233, 255, 79, 99, 124, 255, 79, 99, 124, 45, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 105, 124, 150, 255, 255, 255, 255, 0, 255, 255, 255, 0, 102, 121, 145, 18, 95, 115, 140, 255, 190, 202, 223, 255, 152, 167, 189, 255, 67, 87, 112, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 95, 115, 140, 150, 84, 104, 129, 255, 164, 178, 202, 255, 58, 78, 104, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 95, 115, 140, 6, 70, 90, 116, 255, 59, 79, 105, 255, 55, 75, 101, 87, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0}

Ihandle image = IupImageRGBA(16, 16, imgdata)
    return image
end function

function load_image_PaintPencil()
sequence imgdata =
{
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 194, 126, 104, 73, 173, 108, 94, 255, 173, 108, 94, 255, 188, 121, 101, 48, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 175, 158, 120, 66, 173, 108, 94, 255, 235, 159, 129, 255, 208, 118, 94, 255, 173, 108, 94, 255, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 175, 158, 120, 66, 187, 176, 125, 255, 172, 184, 202, 255, 209, 133, 115, 255, 173, 108, 94, 255, 144, 53, 53, 255, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 175, 158, 120, 66, 185, 172, 115, 255, 238, 224, 140, 255, 217, 196, 108, 255, 134, 134, 125, 255, 144, 53, 53, 255, 131, 57, 47, 78, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 175, 158, 120, 66, 183, 166, 101, 255, 238, 224, 140, 255, 215, 191, 98, 255, 178, 154, 73, 255, 22, 18, 14, 255, 102, 85, 40, 48, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 175, 158, 120, 66, 185, 172, 115, 255, 238, 224, 140, 255, 215, 191, 98, 255, 178, 154, 73, 255, 22, 18, 14, 255, 117, 98, 45, 59, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 175, 158, 120, 66, 183, 166, 101, 255, 238, 224, 140, 255, 215, 191, 98, 255, 178, 154, 73, 255, 22, 18, 14, 255, 117, 98, 45, 59, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 175, 158, 120, 66, 181, 160, 87, 255, 238, 224, 140, 255, 215, 191, 98, 255, 178, 154, 73, 255, 22, 18, 14, 255, 117, 98, 45, 41, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 175, 158, 120, 66, 179, 156, 77, 255, 238, 224, 140, 255, 215, 191, 98, 255, 178, 154, 73, 255, 22, 18, 14, 255, 117, 98, 45, 41, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 152, 157, 163, 255, 199, 183, 136, 255, 226, 206, 116, 255, 178, 154, 73, 255, 22, 18, 14, 255, 82, 68, 37, 40, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 152, 157, 163, 118, 152, 157, 163, 255, 254, 254, 253, 255, 169, 147, 81, 255, 22, 18, 14, 255, 117, 98, 45, 41, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 118, 110, 113, 117, 255, 81, 84, 87, 255, 0, 0, 0, 255, 82, 68, 37, 40, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 224, 0, 0, 0, 118, 81, 84, 87, 104, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0}

Ihandle image = IupImageRGBA(16, 16, imgdata)
    return image
end function

function load_image_PaintColorPicker()
sequence imgdata =
{
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 1, 1, 1, 85, 0, 0, 1, 192, 0, 0, 0, 192, 0, 0, 0, 85,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 7, 11, 15, 37, 8, 12, 16, 70, 79, 81, 83, 224, 205, 205, 205, 255, 136, 138, 142, 255, 11, 13, 15, 203,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 9, 15, 21, 119, 18, 26, 37, 255, 68, 70, 72, 255, 88, 93, 99, 255, 117, 120, 126, 255, 84, 86, 91, 255, 2, 2, 2, 194,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 15, 21, 30, 31, 23, 34, 49, 235, 49, 56, 65, 255, 70, 72, 72, 255, 54, 56, 58, 255, 21, 22, 22, 199, 0, 0, 0, 85,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 152, 166, 185, 255, 20, 30, 42, 42, 21, 32, 45, 237, 49, 56, 65, 255, 7, 9, 13, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 152, 166, 185, 255, 255, 255, 255, 255, 202, 208, 222, 255, 173, 183, 202, 255, 6, 10, 15, 236, 2, 4, 5, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 152, 166, 185, 255, 255, 255, 255, 255, 202, 208, 222, 255, 143, 156, 181, 255, 68, 88, 114, 255, 1, 1, 3, 33, 0, 0, 0, 111, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 152, 166, 185, 255, 255, 255, 255, 255, 214, 220, 230, 255, 143, 156, 181, 255, 68, 88, 114, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 152, 166, 185, 255, 255, 255, 255, 255, 215, 221, 231, 255, 143, 156, 181, 255, 65, 85, 112, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 152, 166, 185, 255, 255, 255, 255, 255, 216, 220, 231, 255, 143, 156, 181, 255, 65, 85, 112, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 152, 166, 185, 255, 216, 220, 231, 218, 143, 156, 181, 255, 66, 86, 113, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 43, 134, 240, 46, 43, 134, 240, 107, 152, 166, 185, 255, 255, 255, 255, 255, 69, 89, 114, 255, 51, 72, 99, 255, 43, 134, 240, 236, 43, 134, 240, 204, 43, 133, 240, 161, 43, 132, 239, 107, 43, 130, 239, 46, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 43, 133, 239, 170, 43, 133, 240, 255, 87, 105, 130, 255, 79, 97, 123, 255, 43, 134, 240, 255, 43, 134, 240, 255, 43, 135, 240, 255, 43, 134, 240, 255, 43, 134, 240, 255, 43, 134, 240, 255, 43, 133, 239, 170, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 42, 120, 237, 46, 42, 124, 238, 107, 42, 125, 238, 161, 42, 126, 238, 204, 42, 128, 238, 236, 43, 130, 239, 253, 43, 131, 239, 236, 43, 131, 239, 204, 43, 131, 239, 161, 43, 129, 239, 107, 42, 127, 238, 46, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0}

Ihandle image = IupImageRGBA(16, 16, imgdata)
    return image
end function

function load_image_PaintEllipse()
sequence imgdata =
{
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 20, 0, 0, 0, 84, 0, 0, 0, 128, 0, 0, 0, 128, 0, 0, 0, 84, 0, 0, 0, 20, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 16, 0, 0, 0, 155, 0, 0, 0, 239, 0, 0, 0, 175, 0, 0, 0, 131, 0, 0, 0, 131, 0, 0, 0, 175, 0, 0, 0, 239, 0, 0, 0, 155, 0, 0, 0, 16, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 24, 0, 0, 0, 215, 0, 0, 0, 143, 0, 0, 0, 16, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 16, 0, 0, 0, 143, 0, 0, 0, 215, 0, 0, 0, 24, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 199, 0, 0, 0, 120, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 120, 0, 0, 0, 199, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 0, 0, 0, 60, 0, 0, 0, 211, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 211, 0, 0, 0, 60, 255, 255, 255, 0,
 255, 255, 255, 0, 0, 0, 0, 120, 0, 0, 0, 139, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 139, 0, 0, 0, 120, 255, 255, 255, 0,
 255, 255, 255, 0, 0, 0, 0, 120, 0, 0, 0, 135, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 135, 0, 0, 0, 120, 255, 255, 255, 0,
 255, 255, 255, 0, 0, 0, 0, 68, 0, 0, 0, 211, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 211, 0, 0, 0, 68, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 199, 0, 0, 0, 120, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 120, 0, 0, 0, 199, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 36, 0, 0, 0, 231, 0, 0, 0, 135, 0, 0, 0, 12, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 12, 0, 0, 0, 135, 0, 0, 0, 231, 0, 0, 0, 36, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 20, 0, 0, 0, 163, 0, 0, 0, 239, 0, 0, 0, 171, 0, 0, 0, 131, 0, 0, 0, 131, 0, 0, 0, 171, 0, 0, 0, 239, 0, 0, 0, 163, 0, 0, 0, 20, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 24, 0, 0, 0, 88, 0, 0, 0, 128, 0, 0, 0, 128, 0, 0, 0, 88, 0, 0, 0, 24, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0}

Ihandle image = IupImageRGBA(16, 16, imgdata)
    return image
end function

function load_image_PaintRect()
sequence imgdata =
{
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 254, 0, 0, 0, 247, 0, 0, 0, 239, 0, 0, 0, 247, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0}

Ihandle image = IupImageRGBA(16, 16, imgdata)
    return image
end function

function load_image_PaintOval()
sequence imgdata =
{
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 24, 0, 0, 0, 135, 0, 0, 0, 211, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 211, 0, 0, 0, 135, 0, 0, 0, 24, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 80, 0, 0, 0, 239, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 239, 0, 0, 0, 80, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 48, 0, 0, 0, 251, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 251, 0, 0, 0, 48, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 183, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 183, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 247, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 247, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 247, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 247, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 183, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 183, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 56, 0, 0, 0, 251, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 251, 0, 0, 0, 56, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 84, 0, 0, 0, 243, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 243, 0, 0, 0, 84, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 24, 0, 0, 0, 139, 0, 0, 0, 211, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 211, 0, 0, 0, 139, 0, 0, 0, 24, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0}

Ihandle image = IupImageRGBA(16, 16, imgdata)
    return image
end function

function load_image_PaintBox()
sequence imgdata =
{
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 254, 0, 0, 0, 247, 0, 0, 0, 239, 0, 0, 0, 247, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 255, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0}

Ihandle image = IupImageRGBA(16, 16, imgdata)
    return image
end function

function load_image_PaintZoomGrid()
sequence imgdata =
{
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 110, 155, 223, 255, 255, 255, 255, 0, 255, 255, 255, 0, 106, 151, 219, 255, 255, 255, 255, 0, 255, 255, 255, 0, 95, 142, 210, 255, 255, 255, 255, 0, 255, 255, 255, 0, 84, 129, 201, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 110, 155, 223, 255, 255, 255, 255, 0, 255, 255, 255, 0, 102, 147, 217, 255, 255, 255, 255, 0, 255, 255, 255, 0, 92, 137, 207, 255, 255, 255, 255, 0, 255, 255, 255, 0, 80, 125, 197, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 110, 155, 223, 255, 110, 155, 223, 255, 107, 152, 222, 255, 104, 151, 219, 255, 103, 148, 216, 255, 100, 145, 213, 255, 97, 142, 210, 255, 93, 138, 206, 255, 88, 133, 203, 255, 84, 129, 201, 255, 80, 125, 197, 255, 76, 121, 193, 255, 72, 117, 189, 255, 68, 113, 183, 255, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 106, 149, 219, 255, 255, 255, 255, 0, 255, 255, 255, 0, 97, 142, 210, 255, 255, 255, 255, 0, 255, 255, 255, 0, 84, 131, 199, 255, 255, 255, 255, 0, 255, 255, 255, 0, 72, 117, 187, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 103, 148, 216, 255, 255, 255, 255, 0, 255, 255, 255, 0, 92, 137, 207, 255, 255, 255, 255, 0, 255, 255, 255, 0, 81, 125, 196, 255, 255, 255, 255, 0, 255, 255, 255, 0, 68, 113, 185, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 104, 151, 219, 255, 104, 148, 216, 255, 100, 145, 213, 255, 97, 142, 210, 255, 92, 137, 207, 255, 88, 135, 203, 255, 84, 129, 199, 255, 80, 125, 195, 255, 76, 121, 193, 255, 70, 117, 189, 255, 68, 112, 183, 255, 62, 109, 181, 255, 60, 105, 177, 255, 57, 102, 174, 255, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 97, 142, 210, 255, 255, 255, 255, 0, 255, 255, 255, 0, 84, 129, 199, 255, 255, 255, 255, 0, 255, 255, 255, 0, 72, 117, 187, 255, 255, 255, 255, 0, 255, 255, 255, 0, 60, 105, 177, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 93, 138, 206, 255, 255, 255, 255, 0, 255, 255, 255, 0, 80, 125, 195, 255, 255, 255, 255, 0, 255, 255, 255, 0, 66, 113, 185, 255, 255, 255, 255, 0, 255, 255, 255, 0, 56, 103, 173, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 95, 140, 212, 255, 92, 137, 207, 255, 88, 133, 203, 255, 84, 129, 199, 255, 80, 125, 195, 255, 76, 121, 193, 255, 72, 117, 187, 255, 68, 113, 185, 255, 64, 107, 181, 255, 59, 105, 178, 255, 55, 101, 174, 255, 53, 98, 170, 255, 49, 95, 168, 255, 48, 91, 165, 255, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 84, 131, 199, 255, 255, 255, 255, 0, 255, 255, 255, 0, 70, 117, 189, 255, 255, 255, 255, 0, 255, 255, 255, 0, 60, 105, 177, 255, 255, 255, 255, 0, 255, 255, 255, 0, 49, 95, 168, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 82, 125, 195, 255, 255, 255, 255, 0, 255, 255, 255, 0, 68, 113, 185, 255, 255, 255, 255, 0, 255, 255, 255, 0, 57, 102, 174, 255, 255, 255, 255, 0, 255, 255, 255, 0, 46, 92, 165, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 84, 129, 199, 255, 80, 125, 195, 255, 76, 121, 191, 255, 72, 117, 189, 255, 66, 113, 185, 255, 64, 109, 181, 255, 60, 105, 177, 255, 55, 102, 174, 255, 52, 98, 171, 255, 49, 95, 168, 255, 46, 91, 166, 255, 44, 90, 163, 255, 42, 88, 161, 255, 42, 88, 161, 255, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 72, 117, 187, 255, 255, 255, 255, 0, 255, 255, 255, 0, 60, 107, 177, 255, 255, 255, 255, 0, 255, 255, 255, 0, 50, 95, 167, 255, 255, 255, 255, 0, 255, 255, 255, 0, 42, 88, 161, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 68, 113, 185, 255, 255, 255, 255, 0, 255, 255, 255, 0, 56, 101, 173, 255, 255, 255, 255, 0, 255, 255, 255, 0, 46, 92, 165, 255, 255, 255, 255, 0, 255, 255, 255, 0, 42, 88, 161, 255, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0}

Ihandle image = IupImageRGBA(16, 16, imgdata)
    return image
end function

function load_image_PaintFill()
sequence imgdata =
{
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 50, 53, 53, 86, 59, 59, 59, 111, 108, 108, 108, 82, 127, 127, 127, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 54, 54, 122, 72, 72, 72, 7, 119, 122, 124, 117, 124, 124, 130, 47, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 77, 77, 76, 154, 144, 166, 188, 23, 158, 169, 181, 191, 144, 151, 159, 194, 134, 147, 174, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 124, 126, 129, 197, 141, 160, 183, 179, 212, 219, 225, 254, 157, 162, 166, 254, 163, 180, 200, 168, 159, 175, 191, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 130, 141, 158, 45, 130, 143, 155, 245, 218, 225, 232, 250, 222, 232, 239, 255, 136, 139, 142, 255, 205, 217, 227, 252, 148, 167, 189, 163, 155, 155, 184, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 127, 148, 170, 24, 134, 155, 174, 172, 213, 220, 227, 254, 218, 233, 243, 255, 197, 207, 217, 255, 149, 149, 150, 255, 232, 241, 245, 255, 179, 196, 213, 252, 129, 147, 172, 164, 75, 103, 144, 37, 17, 51, 102, 15, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 134, 147, 174, 19, 122, 146, 168, 179, 216, 223, 228, 252, 217, 231, 242, 255, 213, 227, 238, 255, 159, 162, 164, 255, 128, 129, 128, 255, 228, 235, 239, 255, 171, 197, 218, 255, 136, 162, 190, 253, 87, 116, 156, 227, 37, 75, 150, 183, 0, 31, 107, 57, 0, 0, 0, 0,
 0, 0, 0, 0, 120, 134, 161, 19, 126, 147, 168, 157, 209, 217, 225, 245, 217, 231, 241, 255, 203, 217, 232, 255, 242, 244, 245, 255, 192, 192, 191, 255, 164, 166, 169, 255, 202, 213, 223, 255, 158, 176, 194, 255, 126, 154, 184, 255, 103, 134, 168, 255, 76, 110, 169, 255, 49, 93, 175, 201, 37, 66, 132, 27,
 122, 132, 160, 27, 102, 124, 149, 172, 194, 209, 220, 241, 213, 228, 239, 246, 204, 218, 232, 249, 241, 242, 244, 255, 247, 245, 245, 255, 243, 244, 243, 255, 222, 228, 234, 255, 192, 203, 214, 255, 159, 172, 185, 255, 138, 152, 168, 255, 84, 116, 151, 248, 74, 104, 158, 246, 83, 129, 213, 243, 77, 108, 169, 92,
 125, 134, 152, 55, 111, 131, 154, 211, 189, 201, 214, 255, 214, 223, 234, 254, 238, 240, 243, 236, 248, 246, 245, 241, 242, 243, 243, 254, 221, 228, 234, 255, 192, 203, 214, 255, 165, 178, 192, 255, 142, 155, 169, 255, 98, 117, 137, 243, 77, 94, 120, 121, 46, 82, 158, 171, 87, 131, 209, 247, 85, 114, 171, 122,
 0, 255, 255, 1, 134, 140, 167, 38, 137, 155, 179, 206, 218, 223, 230, 254, 244, 242, 243, 252, 242, 244, 243, 239, 220, 228, 234, 252, 192, 202, 214, 255, 164, 176, 190, 255, 140, 154, 168, 255, 92, 112, 132, 243, 75, 91, 114, 111, 102, 102, 153, 5, 29, 61, 136, 140, 68, 109, 192, 244, 84, 113, 170, 94,
 0, 0, 0, 0, 0, 0, 255, 1, 157, 173, 195, 47, 148, 166, 191, 205, 204, 210, 220, 248, 227, 231, 235, 253, 193, 204, 216, 255, 163, 175, 189, 255, 138, 151, 166, 255, 95, 113, 134, 242, 74, 88, 113, 110, 95, 127, 127, 8, 0, 0, 0, 0, 35, 66, 135, 145, 72, 109, 182, 239, 91, 120, 178, 53,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 127, 142, 165, 34, 103, 124, 151, 197, 158, 172, 187, 252, 164, 176, 189, 255, 134, 148, 162, 254, 96, 113, 133, 245, 75, 87, 110, 122, 102, 102, 102, 5, 0, 0, 0, 0, 0, 0, 0, 0, 60, 91, 151, 173, 84, 115, 173, 195, 98, 117, 176, 13,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 102, 110, 119, 30, 73, 96, 120, 204, 107, 126, 144, 255, 106, 123, 141, 255, 102, 115, 135, 152, 139, 150, 162, 22, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 92, 154, 173, 85, 115, 173, 119, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 49, 82, 115, 31, 49, 79, 109, 212, 92, 110, 134, 169, 143, 159, 175, 16, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 65, 93, 154, 163, 63, 89, 153, 20, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 109, 118, 140, 58, 85, 106, 148, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 61, 92, 154, 33, 0, 0, 0, 0, 0, 0, 0, 0}

Ihandle image = IupImageRGBA(16, 16, imgdata)
    return image
end function

function load_image_PaintText()
sequence imgdata =
{
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 36, 0, 0, 0, 96, 0, 0, 0, 96, 0, 0, 0, 96, 0, 0, 0, 96, 0, 0, 0, 96, 0, 0, 0, 96, 0, 0, 0, 96, 0, 0, 0, 96, 0, 0, 0, 96, 0, 0, 0, 96, 0, 0, 0, 72, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 96, 0, 0, 0, 255, 0, 0, 0, 203, 0, 0, 0, 124, 0, 0, 0, 135, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 215, 0, 0, 0, 96, 0, 0, 0, 131, 0, 0, 0, 243, 0, 0, 0, 191, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 96, 0, 0, 0, 163, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 64, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 191, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 44, 0, 0, 0, 191, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 96, 0, 0, 0, 48, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 64, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 191, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 116, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 64, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 191, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 64, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 191, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 64, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 191, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 64, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 191, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 64, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 191, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 64, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 191, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 64, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 191, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 64, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 191, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 0, 0, 0, 96, 0, 0, 0, 187, 0, 0, 0, 255, 0, 0, 0, 255, 0, 0, 0, 243, 0, 0, 0, 116, 0, 0, 0, 48, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0,
 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0, 255, 255, 255, 0}

Ihandle image = IupImageRGBA(16, 16, imgdata)
    return image
end function


--/********************************** Utilities *****************************************/


procedure show_error(string message, integer is_error)
    Ihandln mdlg = IupMessageDlg()
--  IupSetStrAttribute(mdlg, "PARENTDIALOG", dlg)
    IupSetAttributeHandle(mdlg, "PARENTDIALOG", dlg)
    IupSetAttribute(mdlg, "DIALOGTYPE", iff(is_error ? "ERROR" : "WARNING"))
    IupSetAttribute(mdlg, "BUTTONS", "OK")
    IupSetStrAttribute(mdlg, "TITLE", iff(is_error ? "Error" : "Warning"))
    IupSetStrAttribute(mdlg, "VALUE", message)
    IupPopup(mdlg, IUP_CENTERPARENT, IUP_CENTERPARENT)
    mdlg = IupDestroy(mdlg)
end procedure

procedure show_file_error(integer error)
    switch error do
        case IM_ERR_OPEN:       show_error("Error Opening File.", 1)
        case IM_ERR_MEM:        show_error("Insufficient memory.", 1)
        case IM_ERR_ACCESS:     show_error("Error Accessing File.", 1)
        case IM_ERR_DATA:       show_error("Image type not Supported.", 1)
        case IM_ERR_FORMAT:     show_error("Invalid Format.", 1)
        case IM_ERR_COMPRESS:   show_error("Invalid or unsupported compression.", 1)
      default:                  show_error("Unknown Error.", 1)
    end switch
end procedure

function read_file(string filename)
atom pError = allocate(machine_word())
imImage image = imFileImageLoadBitmap(filename, 0, pError)
integer error = peekNS(pError,machine_word(),1)
    free(pError)
    if error!=0 then
        show_file_error(error)
    end if
    return image
end function

--!/**/include builtins/write_file.e
--function write_file(string filename, const imImage* image)
function write_file(string filename, imImage image)
string fmt = imImageGetAttribString(image, "FileFormat")
integer error = imFileImageSave(filename, fmt, image)
    if error!=0 then
        show_file_error(error)
        return 0
    end if
    return 1
end function

-- extracted from the SCROLLBAR attribute documentation
procedure scroll_update(atom view_width, atom view_height)
-- view_width and view_height is the virtual space size
-- here we assume XMIN=0, XMAX=1, YMIN=0, YMAX=1
integer elem_width, elem_height
integer canvas_width, canvas_height
integer scrollbar_size = IupGetInt(NULL, "SCROLLBARSIZE")
integer border = IupGetInt(canvas, "BORDER")

    {elem_width, elem_height} = IupGetIntInt(canvas, "RASTERSIZE")

    -- if view is greater than canvas in one direction, then it has scrollbars,
    --    but this affects the opposite direction
    elem_width -= 2*border  -- remove BORDER (always size=1)
    elem_height -= 2*border
    canvas_width = elem_width
    canvas_height = elem_height
    if view_width>elem_width then   -- check for horizontal scrollbar
        canvas_height -= scrollbar_size  -- affect vertical size
    end if
    if view_height>elem_height then
        canvas_width -= scrollbar_size
    end if
    if view_width<=elem_width and view_width>canvas_width then  -- check if still has horizontal scrollbar
        canvas_height -= scrollbar_size
    end if
    if view_height<=elem_height and view_height>canvas_height then
        canvas_width -= scrollbar_size
    end if
    if canvas_width<0 then canvas_width = 0 end if
    if canvas_height<0 then canvas_height = 0 end if

    IupSetFloat(canvas, "DX", canvas_width/view_width)
    IupSetFloat(canvas, "DY", canvas_height/view_height)
end procedure

function scroll_calc_center()
    return {IupGetFloat(canvas, "POSX")+IupGetFloat(canvas, "DX")/2,
            IupGetFloat(canvas, "POSY")+IupGetFloat(canvas, "DY")/2}
end function

procedure scroll_center(atom old_center_x, atom old_center_y)
-- always update the scroll position keeping it proportional to the old position relative to the center of the ih.
atom dx = IupGetFloat(canvas, "DX")
atom dy = IupGetFloat(canvas, "DY")

atom posx = old_center_x-dx/2
atom posy = old_center_y-dy/2

    if posx<0 then posx = 0 end if
    if posx>1-dx then posx = 1-dx end if

    if posy<0 then posy = 0 end if
    if posy>1-dy then posy = 1-dy end if

    IupSetFloat(canvas, "POSX", posx)
    IupSetFloat(canvas, "POSY", posy)
end procedure

procedure scroll_move(integer canvas_width, integer canvas_height, integer move_x, integer move_y, integer view_width, integer view_height)
atom posy = 0
atom posx = 0

    if move_x!=0 or move_y!=0 then
        if canvas_height<view_height then
            posy = IupGetFloat(canvas, "POSY")-move_y/view_height
        end if

        if canvas_width<view_width then
            posx = IupGetFloat(canvas, "POSX")-move_x/view_width
        end if

        if posx!=0 or posy!=0 then
            IupSetFloat(canvas, "POSX", posx)
            IupSetFloat(canvas, "POSY", posy)
            IupUpdate(canvas)
        end if
    end if
end procedure

procedure zoom_update(atom zoom_index)
--  imImage* image = (imImage*)IupGetAttribute(canvas, "IMAGE")
imImage image = IupGetInt(canvas, "IMAGE")
atom zoom_factor = power(2, zoom_index)
    IupSetStrAttribute(zoom_lbl, "TITLE", "%.0f%%", {floor(zoom_factor*100)})
    if image!=NULL then
        atom old_center_x, old_center_y
        atom view_width = zoom_factor*im_width(image)
        atom view_height = zoom_factor*im_height(image)

        {old_center_x, old_center_y} = scroll_calc_center()

        scroll_update(view_width, view_height)

        scroll_center(old_center_x, old_center_y)
    end if
    IupUpdate(canvas)
end procedure

procedure image_flood_fill(atom image, integer start_x, integer start_y, sequence replace_color, atom tol_percent)
atom tol
--  sequence color={cdRed(replace_color),cdGreen(replace_color),cdBlue(replace_color)}

    --  max value = 255*255*3 = 195075
    --  sqrt(195075) = 441
    tol = (441*tol_percent)/100

    -- still too high
    tol = tol/5     -- empirical reduce. TODO: What is the best formula?

    imProcessRenderFloodFill(image, start_x, start_y, replace_color, tol)
end procedure

procedure image_fill_white(atom image)
    imProcessRenderConstant(image, {255,255,255})
end procedure

--void update_image(Ihandle canvas, imImage* image, integer update_size)
procedure update_image(imImage image, integer update_size)
--  imImage* old_image = (imImage*)IupGetAttribute(canvas, "IMAGE")
imImage old_image = IupGetInt(canvas, "IMAGE")

    IupSetAttribute(canvas, "DIRTY", "Yes")
    IupSetInt(canvas, "IMAGE", image)

    if old_image!=NULL then
        old_image = imImageDestroy(old_image)
    end if
    if update_size then
        atom zoom_index = IupGetDouble(zoom_val, "VALUE")
        IupSetStrAttribute(size_lbl, "TITLE", "%d x %d px", {im_width(image), im_height(image)})
        zoom_update(zoom_index)
    else
        IupUpdate(canvas)
    end if
end procedure

procedure set_new_image(atom image, string filename, integer dirty)
--  imImage* old_image = (imImage*)IupGetAttribute(canvas, "IMAGE")
imImage old_image = IupGetInt(canvas, "IMAGE")

    if length(filename) then
        IupSetStrAttribute(canvas, "FILENAME", filename)
--      IupSetStrAttribute(IupGetDialog(canvas), "TITLE", "%s - Simple Paint", get_file_name(filename))
        IupSetStrAttribute(dlg, "TITLE", "%s - Simple Paint", get_file_name(filename))
    else
        IupSetAttribute(canvas, "FILENAME", NULL)
--      IupSetAttribute(IupGetDialog(canvas), "TITLE", "Untitled - Simple Paint")
        IupSetAttribute(dlg, "TITLE", "Untitled - Simple Paint")
    end if

    -- we are going to support only RGB images with no alpha
    imImageRemoveAlpha(image)
--  if (image->color_space != IM_RGB)
    if im_color_space(image)!=IM_RGB then
        imImage new_image = imImageCreateBased(image, -1, -1, IM_RGB, -1)
        imConvertColorSpace(image, new_image)
        image = imImageDestroy(image)
        image = new_image
    end if

    -- default file format
    string fmt = imImageGetAttribString(image, "FileFormat")
    if fmt="" then
        imImageSetAttribString(image, "FileFormat", "JPEG")
    end if
    IupSetAttribute(canvas, "DIRTY", iff(dirty ? "Yes" : "No"))
    IupSetInt(canvas, "IMAGE", image)

--  IupSetStrAttribute(size_lbl, "TITLE", "%d x %d px", {image->width, image->height})
    IupSetStrAttribute(size_lbl, "TITLE", "%d x %d px", {im_width(image), im_height(image)})

    if old_image!=NULL then
        old_image = imImageDestroy(old_image)
    end if
    IupSetDouble(zoom_val, "VALUE", 0)
    zoom_update(0)
end procedure

procedure check_new_file()
    imImage image = IupGetInt(canvas, "IMAGE")
    if image=NULL then
        integer width = IupConfigGetVariableInt(config, "NewImage", "Width", 640)
        integer height = IupConfigGetVariableInt(config, "NewImage", "Height", 480)

        image = imImageCreate(width, height, IM_RGB, IM_BYTE)
        if image=NULL then
            show_file_error(IM_ERR_MEM)
            return
        end if

        image_fill_white(image)

        set_new_image(image, "", 0)
    end if
end procedure

procedure open_file(string filename)
    atom image = read_file(filename)
    if image!=NULL then
        set_new_image(image, filename, 0)
        IupConfigRecentUpdate(config, filename)
    end if
end procedure

procedure save_file()
string filename = IupGetAttribute(canvas, "FILENAME")
imImage image = IupGetInt(canvas, "IMAGE")
    if write_file(filename, image) then
        IupSetAttribute(canvas, "DIRTY", "NO")
    end if
end procedure

procedure set_file_format(atom image, string filename)
string ext = get_file_extension(filename)
string fmt = "JPEG"
    if find(ext,{"jpg","jpeg"}) then
        fmt = "JPEG"
    elsif ext="bmp" then
        fmt = "BMP"
    elsif ext="png" then
        fmt = "PNG"
    elsif ext="tga" then
        fmt = "TGA"
    elsif find(ext,{"tif","tiff"}) then
        fmt = "TIFF"
    end if
    imImageSetAttribString(image, "FileFormat", fmt)
end procedure

procedure saveas_file(string filename)
    imImage image = IupGetInt(canvas, "IMAGE")
--DEV
    set_file_format(image, filename)

    if write_file(filename, image) then

        IupSetStrAttribute(dlg, "TITLE", "%s - Simple Paint", get_file_name(filename))
        IupSetStrAttribute(canvas, "FILENAME", filename)
        IupSetAttribute(canvas, "DIRTY", "NO")

        IupConfigRecentUpdate(config, filename)
    end if
end procedure

function save_check()
    if IupGetInt(canvas, "DIRTY") then
        switch IupAlarm("Warning", "File not saved! Save it now?", "Yes", "No", "Cancel") do
            case 1:  -- save the changes and continue
                save_file()
                break
            case 2:  -- ignore the changes and continue
                break
            case 3:  -- cancel
                return 0
        end switch
    end if
    return 1
end function

procedure toggle_toolbar_visibility()
    if IupGetInt(item_toolbar, "VALUE") then
        IupSetAttribute(toolbar, "FLOATING", "YES")
        IupSetAttribute(toolbar, "VISIBLE", "NO")
        IupSetAttribute(item_toolbar, "VALUE", "OFF")
    else
        IupSetAttribute(toolbar, "FLOATING", "NO")
        IupSetAttribute(toolbar, "VISIBLE", "YES")
        IupSetAttribute(item_toolbar, "VALUE", "ON")
    end if
    IupRefresh(toolbar) -- refresh the dialog layout
end procedure

procedure toggle_statusbar_visibility()
    if IupGetInt(item_statusbar, "VALUE") then
        IupSetAttribute(statusbar, "FLOATING", "YES")
        IupSetAttribute(statusbar, "VISIBLE", "NO")
        IupSetAttribute(item_statusbar, "VALUE", "OFF")
    else
        IupSetAttribute(statusbar, "FLOATING", "NO")
        IupSetAttribute(statusbar, "VISIBLE", "YES")
        IupSetAttribute(item_statusbar, "VALUE", "ON")
    end if
    IupRefresh(statusbar)   -- refresh the dialog layout
end procedure

--/* -- split for plade:
procedure toggle_bar_visibility(Ihandle item, Ihandle ih)
    if IupGetInt(item, "VALUE") then
        IupSetAttribute(ih, "FLOATING", "YES")
        IupSetAttribute(ih, "VISIBLE", "NO")
        IupSetAttribute(item, "VALUE", "OFF")
    else
        IupSetAttribute(ih, "FLOATING", "NO")
        IupSetAttribute(ih, "VISIBLE", "YES")
        IupSetAttribute(item, "VALUE", "ON")
    end if
    IupRefresh(ih)  -- refresh the dialog layout
end procedure
--*/

function select_file(integer is_open)
    string d = IupConfigGetVariableStr(config, "MainWindow", "LastDirectory")
    Ihandln filedlg = IupFileDlg()
    if is_open then
        IupSetAttribute(filedlg, "DIALOGTYPE", "OPEN")
    else
        IupSetAttribute(filedlg, "DIALOGTYPE", "SAVE")
        IupSetStrAttribute(filedlg, "FILE", IupGetAttribute(canvas, "FILENAME"))
    end if
    IupSetAttribute(filedlg, "EXTFILTER", "Image Files|*.bmp;*.jpg;*.png;*.tif;*.tga|All Files|*.*|")
    IupSetStrAttribute(filedlg, "DIRECTORY", d)
    IupSetAttributeHandle(filedlg, "PARENTDIALOG", dlg)

    IupPopup(filedlg, IUP_CENTERPARENT, IUP_CENTERPARENT)
    if IupGetInt(filedlg, "STATUS")!=-1 then
        string filename = IupGetAttribute(filedlg, "VALUE")
        if is_open then
            open_file(filename)
        else
            saveas_file(filename)
        end if
        d = IupGetAttribute(filedlg, "DIRECTORY")
        IupConfigSetVariableStr(config, "MainWindow", "LastDirectory", d)
    end if

    filedlg = IupDestroy(filedlg)
    return IUP_DEFAULT
end function

function view_fit_rect(integer canvas_width, integer canvas_height, integer image_width, integer image_height)
    integer view_width = canvas_width,
            view_height = (canvas_width*image_height)/image_width

    if view_height>canvas_height then
        view_height = canvas_height
        view_width = (canvas_height*image_width)/image_height
    end if
    return {view_width, view_height}
end function

function view_zoom_rect(integer image_width, integer image_height)
integer x, y, canvas_width, canvas_height
integer view_width, view_height
atom zoom_index = IupGetDouble(zoom_val, "VALUE")
atom zoom_factor = power(2, zoom_index)
atom posy = IupGetFloat(canvas, "POSY")
atom posx = IupGetFloat(canvas, "POSX")

    {canvas_width, canvas_height} = IupGetIntInt(canvas, "DRAWSIZE")

    view_width = floor(zoom_factor*image_width)
    view_height = floor(zoom_factor*image_height)

    if canvas_width<view_width then
        x = floor(-posx*view_width)
    else
        x = floor((canvas_width-view_width)/2)
    end if
    if canvas_height<view_height then
        -- posy is top-bottom, CD is bottom-top.
        -- invert posy reference (YMAX-DY - POSY)
        atom dy = IupGetFloat(canvas, "DY")
        posy = 1-dy-posy
        y = floor(-posy*view_height)
    else
        y = floor((canvas_height-view_height)/2)
    end if
    return {zoom_factor, x, y, view_width, view_height}
end function

function view_zoom_offset(integer view_x, integer view_y, integer image_width, integer image_height, atom zoom_factor, integer x, integer y)
    x -= view_x
    y -= view_y

    x = floor(x/zoom_factor)
    y = floor(y/zoom_factor)

    if x<0 then x = 0 end if
    if y<0 then y = 0 end if
    if x>image_width-1 then x = image_width-1 end if
    if y>image_height-1 then y = image_height-1 end if
    return {x,y}
end function

function tool_get_text_enter_cb()
    return IUP_CLOSE
end function

procedure tool_get_text()

    Ihandle text = IupText()
    IupSetAttribute(text, "EXPAND", "YES")
    string txt = IupGetAttribute(toolbox, "TOOLTEXT"),
          font = IupGetAttribute(toolbox, "TOOLFONT")
    IupSetStrAttribute(text, "VALUE", txt)
    IupSetStrAttribute(text, "FONT", font)
    IupSetAttribute(text, "VISIBLECOLUMNS", "20")

    Ihandln text_dlg = IupDialog(text)

    IupSetStrAttribute(text_dlg, "TITLE", "Enter Text:")
    IupSetAttribute(text_dlg, "MINBOX", "NO")
    IupSetAttribute(text_dlg, "MAXBOX", "NO")
    IupSetCallback(text_dlg, "K_CR", Icallback("tool_get_text_enter_cb"))
    IupSetAttributeHandle(text_dlg, "PARENTDIALOG", toolbox)

    IupPopup(text_dlg, IUP_MOUSEPOS, IUP_MOUSEPOS)

    txt = IupGetAttribute(text, "VALUE")
    IupSetStrAttribute(toolbox, "TOOLTEXT", txt)

    text_dlg = IupDestroy(text_dlg)
end procedure

procedure tool_draw_pencil(atom image, integer start_x, integer start_y, integer end_x, integer end_y)
atom res = IupGetDouble(NULL, "SCREENDPI")/25.4
integer r, g, b
cdCanvas rgb_canvas

integer line_width = IupGetInt(toolbox, "TOOLWIDTH")
--  {r,g,b} = IupGetRGB(toolbox, "TOOLCOLOR")
    {r,g,b} = IupGetRGB(toolcolor_btn, "BGCOLOR")

    -- do not use line style here
    rgb_canvas = cdCreateCanvas(CD_IMIMAGE, image)
--  cdCanvasSetfAttribute(rgb_canvas, "RESOLUTION", "%g", res)
    cdCanvasSetAttribute(rgb_canvas, "RESOLUTION", "%g", {res})
    cdCanvasSetForeground(rgb_canvas, cdEncodeColor(r, g, b))
    cdCanvasSetLineWidth(rgb_canvas, line_width)
    cdCanvasLine(rgb_canvas, start_x, start_y, end_x, end_y)
    cdKillCanvas(rgb_canvas)
end procedure

procedure tool_draw_overlay(cdCanvas cd_canvas, integer start_x, integer start_y, integer end_x, integer end_y)
integer tool_index = IupGetInt(toolbox, "TOOLINDEX")
integer line_width = IupGetInt(toolbox, "TOOLWIDTH")
integer line_style = IupGetInt(toolbox, "TOOLSTYLE")-1
--integer {r, g, b} = IupGetRGB(toolbox, "TOOLCOLOR")
integer {r, g, b} = IupGetRGB(toolcolor_btn, "BGCOLOR")

    cdCanvasSetForeground(cd_canvas, cdEncodeColor(r, g, b))
    cdCanvasSetLineWidth(cd_canvas, line_width)
    if line_width==1 then
        cdCanvasSetLineStyle(cd_canvas, line_style)
    end if
    if tool_index==3 then   -- Line
        cdCanvasLine(cd_canvas, start_x, start_y, end_x, end_y)
    elsif tool_index==4 then  -- Rect
        cdCanvasRect(cd_canvas, start_x, end_x, start_y, end_y)
    elsif tool_index==5 then  -- Box
        cdCanvasBox(cd_canvas, start_x, end_x, start_y, end_y)
    elsif tool_index==6 then  -- Ellipse
        cdCanvasArc(cd_canvas, (end_x+start_x)/2, (end_y+start_y)/2, abs(end_x-start_x), abs(end_y-start_y), 0, 360)
    elsif tool_index==7 then  -- Oval
        cdCanvasSector(cd_canvas, (end_x+start_x)/2, (end_y+start_y)/2, abs(end_x-start_x), abs(end_y-start_y), 0, 360)
    elsif tool_index==8 then  -- Text
        {} = cdCanvasTextAlignment(cd_canvas, CD_SOUTH_WEST)
--      cdCanvasNativeFont(cd_canvas, IupGetAttribute(toolbox, "TOOLFONT"))
        cdCanvasSetNativeFont(cd_canvas, IupGetAttribute(toolbox, "TOOLFONT"))
        cdCanvasText(cd_canvas, end_x, end_y, IupGetAttribute(toolbox, "TOOLTEXT"))
    end if
end procedure


--/********************************** Callbacks *****************************************/


function canvas_action_cb(Ihandle /*canvas*/)
integer ri, gi, bi
imImage image
cdCanvas cd_canvas = IupGetInt(canvas, "cdCanvas")
--Ihandle config = IupGetInt(canvas, "CONFIG")
string background = IupConfigGetVariableStr(config, "Canvas", "Background", "208 208 208")

--  if USE_OPENGL then
        IupGLMakeCurrent(canvas)
--  end if
    cdCanvasActivate(cd_canvas)

    -- draw the background
--  sscanf(background, "%u %u %u", &ri, &gi, &bi)
    {{ri,gi,bi}} = scanf(background,"%d %d %d")
    cdCanvasSetBackground(cd_canvas, cdEncodeColor(ri, gi, bi))
    cdCanvasClear(cd_canvas)

    -- draw the image at the center of the canvas
    image = IupGetInt(canvas, "IMAGE")
    if image!=NULL then
        integer x, y, view_width, view_height
        {?,x,y,view_width,view_height} = view_zoom_rect(im_width(image), im_height(image))

        -- black line around the image
        cdCanvasSetForeground(cd_canvas, CD_BLACK)
        cdCanvasSetLineWidth(cd_canvas, 1)
        cdCanvasSetLineStyle(cd_canvas, CD_CONTINUOUS)
        cdCanvasRect(cd_canvas, x-1, x+view_width, y-1, y+view_height)

        -- Some CD drivers have interpolation options for image zoom
        -- we force NEAREST so we can see the pixel boundary in zoom in
        -- an alternative would be to set BILINEAR when zoom out
        cdCanvasSetAttribute(cd_canvas, "IMGINTERP", "NEAREST")  -- affects only drivers that have this attribute
        cdCanvasPutImImage(cd_canvas, image, x, y, view_width, view_height)

        if IupConfigGetVariableInt(config, "Canvas", "ZoomGrid") then
            atom zoom_index = IupGetDouble(zoom_val, "VALUE")
            if zoom_index>1 then
--              integer ix, iy
                atom zoom_factor = power(2, zoom_index)

                cdCanvasSetForeground(cd_canvas, CD_GRAY)

                for ix=1 to im_width(image) do
                    integer gx = floor((ix-1)*zoom_factor)
                    cdCanvasLine(cd_canvas, gx+x, y, gx+x, y+view_height)
                end for
                for iy=1 to im_height(image) do
                    integer gy = floor((iy-1)*zoom_factor)
                    cdCanvasLine(cd_canvas, x, gy+y, x+view_width, gy+y)
                end for
            end if
        end if

        if IupGetInt(canvas, "OVERLAY") then
--          Ihandle toolbox = IupGetInt(canvas, "TOOLBOX")
            integer start_x = IupGetInt(canvas, "START_X")
            integer start_y = IupGetInt(canvas, "START_Y")
            integer end_x = IupGetInt(canvas, "END_X")
            integer end_y = IupGetInt(canvas, "END_Y")

            atom scale_x = view_width/im_width(image)
            atom scale_y = view_height/im_height(image)

            -- offset and scale drawing in screen to match the image
            if scale_x>1 or scale_y>1 then
                -- also draw at the center of the pixel when zoom in
                cdCanvasTransformTranslate(cd_canvas, x+scale_x/2, y+scale_y/2)
            else
                cdCanvasTransformTranslate(cd_canvas, x, y)
            end if
            cdCanvasTransformScale(cd_canvas, scale_x, scale_y)

            tool_draw_overlay(cd_canvas, start_x, start_y, end_x, end_y)

            cdCanvasTransform(cd_canvas, NULL)
        end if
    end if

    cdCanvasFlush(cd_canvas)

--  if USE_OPENGL then
        IupGLSwapBuffers(canvas)
--  end if
    return IUP_DEFAULT
end function

function canvas_map_cb(Ihandle /*canvas*/)
cdCanvas cd_canvas

--  if USE_OPENGL then
        atom res = IupGetDouble(NULL, "SCREENDPI")/25.4
        IupGLMakeCurrent(canvas)
--      cd_canvas = cdCreateCanvasf(CD_GL, "10x10 %g", res)
        cd_canvas = cdCreateCanvas(CD_GL, "10x10 %g", {res})
--  else
--      if USE_CONTEXTPLUS then
--          cdUseContextPlus(1)
--      end if
--      cd_canvas = cdCreateCanvas(CD_IUPDBUFFER, canvas)
--      if USE_CONTEXTPLUS then
--          cdUseContextPlus(0)
--      end if
--  end if

    IupSetInt(canvas, "cdCanvas", cd_canvas)
    return IUP_DEFAULT
end function

function canvas_unmap_cb(Ihandle /*canvas*/)
cdCanvas cd_canvas = IupGetInt(canvas, "cdCanvas")
    cdKillCanvas(cd_canvas)
    return IUP_DEFAULT
end function

function zoomout_action_cb(Ihandle /*ih*/)
atom zoom_index = IupGetDouble(zoom_val, "VALUE")-1
    if zoom_index< -6 then
        zoom_index = -6
    end if
    IupSetDouble(zoom_val, "VALUE", round(zoom_index))  -- fixed increments when using buttons

    zoom_update(zoom_index)
    return IUP_DEFAULT
end function

function zoomin_action_cb(Ihandle /*ih*/)
atom zoom_index = IupGetDouble(zoom_val, "VALUE")+1
    if zoom_index>6 then
        zoom_index = 6
    end if
    IupSetDouble(zoom_val, "VALUE", round(zoom_index))  -- fixed increments when using buttons

    zoom_update(zoom_index)
    return IUP_DEFAULT
end function

function actualsize_action_cb(Ihandle /*ih*/)
    IupSetDouble(zoom_val, "VALUE", 0)
    zoom_update(0)
    return IUP_DEFAULT
end function

function canvas_resize_cb(Ihandle /*canvas*/)
imImage image = IupGetInt(canvas, "IMAGE")
    if image!=NULL then
        atom zoom_index = IupGetDouble(zoom_val, "VALUE")
        atom zoom_factor = power(2, zoom_index)
        atom old_center_x, old_center_y

        integer view_width = floor(zoom_factor*im_width(image))
        integer view_height = floor(zoom_factor*im_height(image))

        {old_center_x, old_center_y} = scroll_calc_center()

        scroll_update(view_width, view_height)

        scroll_center(old_center_x, old_center_y)
    end if

--  if USE_OPENGL then
        integer canvas_width, canvas_height
        atom res = IupGetDouble(NULL, "SCREENDPI")/25.4
        cdCanvas cd_canvas = IupGetInt(canvas, "cdCanvas")
        {canvas_width, canvas_height} = IupGetIntInt(canvas, "DRAWSIZE")

        IupGLMakeCurrent(canvas)
        cdCanvasSetAttribute(cd_canvas, "SIZE", "%dx%d %g", {canvas_width, canvas_height, res})
--  end if
    return IUP_DEFAULT
end function

function canvas_wheel_cb(Ihandle /*canvas*/, atom wheeldelta)
    if IupGetInt(NULL, "CONTROLKEY") then
        if wheeldelta<0 then
            {} = zoomout_action_cb(canvas)
        else
            {} = zoomin_action_cb(canvas)
        end if
    else
        atom posy = IupGetFloat(canvas, "POSY")
        posy -= wheeldelta*IupGetFloat(canvas, "DY")/10
        IupSetFloat(canvas, "POSY", posy)
        IupUpdate(canvas)
    end if
    return IUP_DEFAULT
end function

function canvas_button_cb(Ihandle /*canvas*/, integer button, integer pressed, integer x, integer y)
imImage image = IupGetInt(canvas, "IMAGE")
    if image!=NULL then
        integer cursor_x = x, cursor_y = y
        integer view_x, view_y, view_width, view_height
        atom zoom_factor
        {zoom_factor, view_x, view_y, view_width, view_height} = view_zoom_rect(im_width(image), im_height(image))

        -- y is top-down in IUP
        integer canvas_height = IupGetInt2(canvas, "DRAWSIZE")
        y = canvas_height-y-1

        -- inside image area
        if x>view_x and y>view_y and x<view_x+view_width and y<view_y+view_height then
            {x,y} = view_zoom_offset(view_x, view_y, im_width(image), im_height(image), zoom_factor, x, y)

            if button==IUP_BUTTON1 then
                if pressed then
                    IupSetInt(canvas, "START_X", x)
                    IupSetInt(canvas, "START_Y", y)
                    IupSetInt(canvas, "START_CURSOR_X", cursor_x)
                    IupSetInt(canvas, "START_CURSOR_Y", cursor_y)
                else
--                  Ihandle toolbox = IupGetInt(canvas, "TOOLBOX")
                    integer tool_index = IupGetInt(toolbox, "TOOLINDEX")

                    if tool_index==1 then   -- Color Picker
                        Ihandle color = IupGetDialogChild(toolbox, "COLOR")
                        integer {r,g,b} = im_pixel(image,x,y)
                        IupSetRGB(color, "BGCOLOR", r, g, b)
--                      IupSetRGB(toolbox, "TOOLCOLOR", r, g, b)
                        IupSetRGB(toolcolor_btn, "BGCOLOR", r, g, b)
                    elsif tool_index==2 then  -- Pencil
                        integer start_x = IupGetInt(canvas, "START_X")
                        integer start_y = IupGetInt(canvas, "START_Y")

                        tool_draw_pencil(image, start_x, start_y, x, y)

                        IupSetAttribute(canvas, "DIRTY", "Yes")

                        IupUpdate(canvas)

                        IupSetInt(canvas, "START_X", x)
                        IupSetInt(canvas, "START_Y", y)
                    elsif tool_index>=3 and tool_index<=8 then  -- Shapes
                        if IupGetInt(canvas, "OVERLAY") then
                            integer start_x = IupGetInt(canvas, "START_X")
                            integer start_y = IupGetInt(canvas, "START_Y")
                            atom res = IupGetDouble(NULL, "SCREENDPI")/25.4

                            cdCanvas rgb_canvas = cdCreateCanvas(CD_IMIMAGE, image)
                            cdCanvasSetAttribute(rgb_canvas, "RESOLUTION", "%g", {res})

                            tool_draw_overlay(rgb_canvas, start_x, start_y, x, y)

                            cdKillCanvas(rgb_canvas)

                            IupSetAttribute(canvas, "OVERLAY", NULL)
                            IupSetAttribute(canvas, "DIRTY", "Yes")

                            IupUpdate(canvas)
                        end if
                    elsif tool_index==9 then  -- Fill Color
                        atom tol_percent = IupGetDouble(toolbox, "TOOLFILLTOL")
--                      integer {r, g, b} = IupGetRGB(toolbox, "TOOLCOLOR")
--                      sequence colour = IupGetRGB(toolbox, "TOOLCOLOR")
                        sequence colour = IupGetRGB(toolcolor_btn, "BGCOLOR")

--                      image_flood_fill(image, x, y, cdEncodeColor(r, g, b), tol_percent)
--                      image_flood_fill(image, x, y, {r, g, b}, tol_percent)
                        image_flood_fill(image, x, y, colour, tol_percent)
                        IupSetAttribute(canvas, "DIRTY", "Yes")

                        IupUpdate(canvas)
                    end if
                end if
            elsif button==IUP_BUTTON3 then
                if not pressed then
--                  Ihandle toolbox = IupGetInt(canvas, "TOOLBOX")
                    integer tool_index = IupGetInt(toolbox, "TOOLINDEX")
                    if tool_index==8 then   -- Text
                        tool_get_text()
                    end if
                end if
            end if
        end if
    end if

    return IUP_DEFAULT
end function

function canvas_motion_cb(Ihandle /*canvas*/, integer x, integer y, atom pStatus)
imImage image = IupGetInt(canvas, "IMAGE")
    if image!=NULL then
        integer cursor_x = x, cursor_y = y
        integer view_x, view_y, view_width, view_height
        atom zoom_factor
        {zoom_factor, view_x, view_y, view_width, view_height} = view_zoom_rect(im_width(image), im_height(image))

        -- y is top-down in IUP
        integer canvas_height = IupGetInt2(canvas, "DRAWSIZE")
        y = canvas_height-y-1

        -- inside image area
        if x>view_x and y>view_y and x<view_x+view_width and y<view_y+view_height then
            {x, y} = view_zoom_offset(view_x, view_y, im_width(image), im_height(image), zoom_factor, x, y)
            integer {r,g,b} = im_pixel(image,x,y)
            IupSetStrAttribute(status_lbl, "TITLE", "(%4d, %4d) = %3d %3d %3d", {x, y, r, g, b})

            if iup_isbutton1(pStatus) then -- left mouse down
--              Ihandle toolbox = IupGetInt(canvas, "TOOLBOX")
                integer tool_index = IupGetInt(toolbox, "TOOLINDEX")

                if tool_index==0 then  -- Pointer
                    integer start_cursor_x = IupGetInt(canvas, "START_CURSOR_X")
                    integer start_cursor_y = IupGetInt(canvas, "START_CURSOR_Y")

                    integer canvas_width = IupGetInt(canvas, "DRAWSIZE")

                    scroll_move(canvas_width, canvas_height, cursor_x-start_cursor_x, cursor_y-start_cursor_y, view_width, view_height)

                    IupSetInt(canvas, "START_CURSOR_X", cursor_x)
                    IupSetInt(canvas, "START_CURSOR_Y", cursor_y)
                elsif tool_index==2 then    -- Pencil
                    integer start_x = IupGetInt(canvas, "START_X")
                    integer start_y = IupGetInt(canvas, "START_Y")

                    tool_draw_pencil(image, start_x, start_y, x, y)

                    IupSetAttribute(canvas, "DIRTY", "Yes")

                    IupUpdate(canvas)

                    IupSetInt(canvas, "START_X", x)
                    IupSetInt(canvas, "START_Y", y)
                elsif tool_index>=3 and tool_index<=8 then  -- Shapes
                    IupSetInt(canvas, "END_X", x)
                    IupSetInt(canvas, "END_Y", y)
                    IupSetAttribute(canvas, "OVERLAY", "Yes")
                    IupUpdate(canvas)
                end if
            end if
        end if
    end if

    return IUP_DEFAULT
end function

function zoom_valuechanged_cb(Ihandle /*zoom_val*/)
atom zoom_index = IupGetDouble(zoom_val, "VALUE")
    zoom_update(zoom_index)
    return IUP_DEFAULT
end function

function dropfiles_cb(Ihandle /*ih*/, atom pFilename)
    if save_check() then
        open_file(peek_string(pFilename))
    end if
    return IUP_DEFAULT
end function

function file_menu_open_cb(Ihandle /*file_menu*/)
--Ihandle item_revert = IupGetDialogChild(ih, "ITEM_REVERT")
--Ihandle item_save = IupGetDialogChild(ih, "ITEM_SAVE")
string filename = IupGetAttribute(canvas, "FILENAME")
integer dirty = IupGetInt(canvas, "DIRTY")

    IupSetAttribute(item_save, "ACTIVE", iff(dirty?"YES":"NO"))
    IupSetAttribute(item_revert, "ACTIVE", iff(dirty and length(filename)?"YES":"NO"))
    return IUP_DEFAULT
end function

function edit_menu_open_cb(Ihandle /*edit_menu*/)
--DEV
--Ihandle item_paste = IupGetDialogChild(ih, "ITEM_PASTE")

    if IupGetInt(clipboard, "IMAGEAVAILABLE")=0 then
        IupSetAttribute(item_paste, "ACTIVE", "NO")
    else
        IupSetAttribute(item_paste, "ACTIVE", "YES")
    end if
    return IUP_DEFAULT
end function

function config_recent_cb(Ihandle /*config*/)
    if save_check() then
        string filename = IupGetAttribute(config, "TITLE")
        open_file(filename)
    end if
    return IUP_DEFAULT
end function

function item_new_action_cb(Ihandle /*item_new*/)
    if save_check() then
        integer width = IupConfigGetVariableInt(config, "NewImage", "Width", 640)
        integer height = IupConfigGetVariableInt(config, "NewImage", "Height", 480)

        sequence res = IupGetParam("New Image", NULL, NULL, "Width: %i[1,]\nHeight: %i[1,]\n", {width, height})
        if res[$] then
            {width, height} = res
            imImage image = imImageCreate(width, height, IM_RGB, IM_BYTE)
            if image=NULL then
                show_file_error(IM_ERR_MEM)
                return IUP_DEFAULT
            end if

            image_fill_white(image)

            IupConfigSetVariableInt(config, "NewImage", "Width", width)
            IupConfigSetVariableInt(config, "NewImage", "Height", height)

            set_new_image(image, "", 0)
        end if
    end if
    return IUP_DEFAULT
end function

function item_open_action_cb(Ihandle /*item_open*/)
    if not save_check() then
        return IUP_DEFAULT
    end if
    return select_file(1)
end function

function item_saveas_action_cb(Ihandle /*item_saveas*/)
    return select_file(0)
end function

function item_save_action_cb(Ihandle item_save) -- (or btn_save)
--Ihandle canvas = IupGetDialogChild(item_save, "CANVAS")
string filename = IupGetAttribute(canvas, "FILENAME")
    if length(filename)=0 then
        {} = item_saveas_action_cb(item_save)
    else
        -- test again because in can be called using the hot key
        if IupGetInt(canvas, "DIRTY") then
            save_file()
        end if
    end if
    return IUP_DEFAULT
end function

function item_revert_action_cb(Ihandle /*item_revert*/)
--Ihandle canvas = IupGetDialogChild(item_revert, "CANVAS")
string filename = IupGetAttribute(canvas, "FILENAME")
    open_file(filename)
    return IUP_DEFAULT
end function

function item_pagesetup_action_cb(Ihandle /*item_pagesetup*/)
--Ihandle canvas = IupGetDialogChild(item_pagesetup, "CANVAS")
--Ihandle config = IupGetInt(canvas, "CONFIG")
integer margin_width = IupConfigGetVariableInt(config, "Print", "MarginWidth", 20)
integer margin_height = IupConfigGetVariableInt(config, "Print", "MarginHeight", 20)
string title = "Page Setup"
atom action = NULL
atom user_data = NULL
string fmt = "Margin Width (mm): %i[1,]\nMargin Height (mm): %i[1,]\n"
sequence params = {margin_width, margin_height}
sequence res = IupGetParam(title, action, user_data, fmt, params)
    if res[$] then
        {margin_width, margin_height} = res
        IupConfigSetVariableInt(config, "Print", "MarginWidth", margin_width)
        IupConfigSetVariableInt(config, "Print", "MarginHeight", margin_height)
    end if

    return IUP_DEFAULT
end function

function item_print_action_cb(Ihandle /*item_print*/)
--Ihandle canvas = IupGetDialogChild(item_print, "CANVAS")
imImage image
--string title = IupGetAttribute(IupGetDialog(item_print), "TITLE")
string title = IupGetAttribute(dlg, "TITLE")
cdCanvan print_canvas = cdCreateCanvas(CD_PRINTER, "%s -d", {title})
    if print_canvas=NULL then
        return IUP_DEFAULT
    end if

    -- do NOT draw the background, use the paper color

    -- draw the image at the center of the canvas
    image = IupGetInt(canvas, "IMAGE")
    if image!=NULL then
        integer x, y, canvas_width, canvas_height, view_width, view_height
        atom canvas_width_mm, canvas_height_mm
--      Ihandle config = IupGetInt(canvas, "CONFIG")
        integer margin_width = IupConfigGetVariableInt(config, "Print", "MarginWidth", 20)
        integer margin_height = IupConfigGetVariableInt(config, "Print", "MarginHeight", 20)

        {canvas_width, canvas_height, canvas_width_mm, canvas_height_mm} = cdCanvasGetSize(print_canvas)

        -- convert to pixels
        margin_width = floor((margin_width*canvas_width)/canvas_width_mm)
        margin_height = floor((margin_height*canvas_height)/canvas_height_mm)

        {view_width, view_height} = view_fit_rect(canvas_width-2*margin_width,
                                                  canvas_height-2*margin_height,
                                                  im_width(image), im_height(image))

        x = (canvas_width-view_width)/2
--      y = (canvas_height-view_height)/2
        y = floor((canvas_height-view_height)/2)

        cdCanvasPutImImage(print_canvas, image, x, y, view_width, view_height)
    end if

    cdKillCanvas(print_canvas)
    return IUP_DEFAULT
end function

function item_exit_action_cb(Ihandle /*item_exit*/)
imImage image = IupGetInt(canvas, "IMAGE")

    if not save_check() then
        return IUP_IGNORE   -- to abort the CLOSE_CB callback
    end if
    if IupGetInt(toolbox, "VISIBLE") then
        IupConfigDialogClosed(config, toolbox, "Toolbox")
        IupHide(toolbox)
    end if

    if image!=NULL then
        image = imImageDestroy(image)
    end if
    IupConfigDialogClosed(config, dlg, "MainWindow")
    {} = IupConfigSave(config)
    config = IupDestroy(config)
    return IUP_CLOSE
end function

function item_copy_action_cb(Ihandle /*item_copy*/)
imImage image = IupGetInt(canvas, "IMAGE")
    IupSetInt(clipboard, "NATIVEIMAGE", IupGetImageNativeHandle(image))
    return IUP_DEFAULT
end function

function item_paste_action_cb(Ihandle /*item_paste*/)
    if save_check() then

        imImage image = IupGetNativeHandleImage(IupGetInt(clipboard, "NATIVEIMAGE"))

        if image=NULL then
            show_error("Invalid Clipboard Data", 1)
            return IUP_DEFAULT
        end if

        set_new_image(image, "", 1) -- set dirty
    end if
    return IUP_DEFAULT
end function

function item_background_action_cb(Ihandle /*item_background*/)
    Ihandln colordlg = IupColorDlg()
    string background = IupConfigGetVariableStr(config, "Canvas", "Background", "255 255 255")
    IupSetStrAttribute(colordlg, "VALUE", background)
--DEV
--if IupGetDialog(item_background)!=dlg then ?9/0 end if
--  IupSetAttributeHandle(colordlg, "PARENTDIALOG", IupGetDialog(item_background))
    IupSetAttributeHandle(colordlg, "PARENTDIALOG", dlg)

    IupPopup(colordlg, IUP_CENTERPARENT, IUP_CENTERPARENT)

    if IupGetInt(colordlg, "STATUS")==1 then
        background = IupGetAttribute(colordlg, "VALUE")
        IupConfigSetVariableStr(config, "Canvas", "Background", background)

        IupUpdate(canvas)
    end if

    colordlg = IupDestroy(colordlg)
    return IUP_DEFAULT
end function

function item_zoomgrid_action_cb(Ihandle /*(item|btn)_zoomgrid*/)
--Ihandle item_zoomgrid = IupGetDialogChild(ih, "ZOOMGRID")
--Ihandle canvas = IupGetDialogChild(ih, "CANVAS")
--Ihandle config = IupGetInt(ih, "CONFIG")

    if IupGetInt(item_zoomgrid, "VALUE") then
        IupSetAttribute(item_zoomgrid, "VALUE", "OFF")
    else
        IupSetAttribute(item_zoomgrid, "VALUE", "ON")
    end if
    IupConfigSetVariableInt(config, "Canvas", "ZoomGrid", IupGetInt(item_zoomgrid, "VALUE"))

    IupUpdate(canvas)
    return IUP_DEFAULT
end function

function item_toolbar_action_cb(Ihandle /*item_toolbar*/)
--Ihandle toolbar = IupGetDialogChild(item_toolbar, "TOOLBAR")
--Ihandle config = IupGetInt(item_toolbar, "CONFIG")

--  toggle_bar_visibility(item_toolbar, toolbar)
    toggle_toolbar_visibility()

    IupConfigSetVariableInt(config, "MainWindow", "Toolbar", IupGetInt(item_toolbar, "VALUE"))
    return IUP_DEFAULT
end function

function item_toolbox_action_cb(Ihandle /*item_toolbox*/)
--Ihandle toolbox = IupGetInt(item_toolbox, "TOOLBOX")
--Ihandle config = IupGetInt(item_toolbox, "CONFIG")

    if IupGetInt(toolbox, "VISIBLE") then
        IupSetAttribute(item_toolbox, "VALUE", "OFF")
        IupConfigDialogClosed(config, toolbox, "Toolbox")
        IupHide(toolbox)
    else
        IupSetAttribute(item_toolbox, "VALUE", "ON")
        IupConfigDialogShow(config, toolbox, "Toolbox")
    end if

    IupConfigSetVariableInt(config, "MainWindow", "Toolbox", IupGetInt(item_toolbox, "VALUE"))
    return IUP_DEFAULT
end function

function item_statusbar_action_cb(Ihandle /*item_statusbar*/)

--  toggle_bar_visibility(item_statusbar, statusbar)
    toggle_statusbar_visibility()

    IupConfigSetVariableStr(config, "MainWindow", "Statusbar", IupGetAttribute(item_statusbar, "VALUE"))
    return IUP_DEFAULT
end function

function item_help_action_cb()
    {} = IupHelp("http://www.tecgraf.puc-rio.br/iup")
    return IUP_DEFAULT
end function

function item_about_action_cb()
    IupMessage("About", "   Simple Paint\n\nAutors:\n   Gustavo Lyrio\n   Antonio Scuri")
    return IUP_DEFAULT
end function

function toolbox_close_cb(Ihandle /*toolbox*/)
--Ihandle config = IupGetInt(toolbox, "CONFIG")
--Ihandle canvas = IupGetInt(toolbox, "CANVAS")
--DEV
--Ihandle item_toolbox = IupGetDialogChild(canvas, "TOOLBOXMENU")

    IupConfigDialogClosed(config, toolbox, "Toolbox")

    IupSetAttribute(item_toolbox, "VALUE", "OFF")
    IupConfigSetVariableStr(config, "MainWindow", "Toolbox", "OFF")
    return IUP_DEFAULT
end function

--DEV
function tool_action_cb(Ihandle ih, integer state)
    if state==1 then
--      Ihandle canvas = IupGetInt(ih, "CANVAS")
        integer tool_index = IupGetInt(ih, "TOOLINDEX")
--      IupSetInt(IupGetDialog(ih), "TOOLINDEX", tool_index)
        IupSetInt(toolbox, "TOOLINDEX", tool_index)

        if tool_index==0 then
            IupSetAttribute(canvas, "CURSOR", "ARROW")
        else
            IupSetAttribute(canvas, "CURSOR", "CROSS")
        end if
        if tool_index==8 then
            tool_get_text()
        end if
    end if
    return IUP_DEFAULT
end function
constant cb_tool_action = Icallback("tool_action_cb")

--DEV merge with above... (item_background_action_cb)
function toolcolor_action_cb(Ihandle /*toolcolor_btn*/)
Ihandln colordlg2 = IupColorDlg()
string color = IupGetAttribute(toolcolor_btn, "BGCOLOR")
    IupSetStrAttribute(colordlg2, "VALUE", color)
--DEV
if IupGetDialog(toolcolor_btn)!=toolbox then ?9/0 end if
    IupSetAttributeHandle(colordlg2, "PARENTDIALOG", IupGetDialog(toolcolor_btn))

    IupPopup(colordlg2, IUP_CENTER, IUP_CENTER)

    if IupGetInt(colordlg2, "STATUS")==1 then
        color = IupGetAttribute(colordlg2, "VALUE")

        IupSetStrAttribute(toolcolor_btn, "BGCOLOR", color)
--      IupSetStrAttribute(IupGetDialog(toolcolor_btn), "TOOLCOLOR", color)
--      IupSetStrAttribute(toolbox, "TOOLCOLOR", color)
    end if

    colordlg2 = IupDestroy(colordlg2)
    return IUP_DEFAULT
end function

function toolwidth_valuechanged_cb(Ihandle /*toolwidth_txt*/)
string value = IupGetAttribute(toolwidth_txt, "VALUE")
--  IupSetStrAttribute(IupGetDialog(toolwidth_txt), "TOOLWIDTH", value)
    IupSetStrAttribute(toolbox, "TOOLWIDTH", value)
    return IUP_DEFAULT
end function

function toolstyle_valuechanged_cb(Ihandle /*toolstyle_lst*/)
string value = IupGetAttribute(toolstyle_lst, "VALUE")
--  IupSetStrAttribute(IupGetDialog(toolstyle_lst), "TOOLSTYLE", value)
    IupSetStrAttribute(toolbox, "TOOLSTYLE", value)
    return IUP_DEFAULT
end function

function toolfont_action_cb(Ihandle /*toolfont_btn*/)
Ihandln font_dlg = IupFontDlg()
string font = IupGetAttribute(toolfont_btn, "TOOLFONT")
--DEV
if IupGetDialog(toolfont_btn)!=toolbox then ?9/0 end if
    IupSetAttributeHandle(font_dlg, "PARENTDIALOG", IupGetDialog(toolfont_btn))
    IupSetStrAttribute(font_dlg, "VALUE", font)

    IupPopup(font_dlg, IUP_CENTER, IUP_CENTER)

    if IupGetInt(font_dlg, "STATUS")==1 then
        font = IupGetAttribute(font_dlg, "VALUE")
--      IupSetStrAttribute(IupGetDialog(toolfont_btn), "TOOLFONT", font)
        IupSetStrAttribute(toolbox, "TOOLFONT", font)
    end if
    font_dlg = IupDestroy(font_dlg)
    return IUP_DEFAULT
end function

function toolfilltol_valuechanged_cb(Ihandle /*filltol_val*/)
--Ihandle filltol_label = IupGetDialogChild(filltol_val, "FILLTOLLABEL")
atom v = IupGetDouble(filltol_val, "VALUE")
    IupSetStrAttribute(filltol_label, "TITLE", "Tol.: %.0f%%", {v})
--  IupSetDouble(IupGetDialog(filltol_val), "TOOLFILLTOL", v)
    IupSetDouble(toolbox, "TOOLFILLTOL", v)
    return IUP_DEFAULT
end function

function main_dlg_move_cb(Ihandle /*dlg*/, integer x, integer y)
--Ihandln toolbox = IupGetInt(dlg, "TOOLBOX")
integer old_x = IupGetInt(dlg, "_OLD_X")
integer old_y = IupGetInt(dlg, "_OLD_Y")

    if old_x==x and old_y==y then
        return IUP_DEFAULT
    end if
    if toolbox!=NULL then --DEV
        if IupGetInt(toolbox, "VISIBLE") then
            integer tb_x = IupGetInt(toolbox, "X")
            integer tb_y = IupGetInt(toolbox, "Y")

            tb_x += x-old_x
            tb_y += y-old_y

            IupShowXY(toolbox, tb_x, tb_y)
        end if
    end if

    IupSetInt(dlg, "_OLD_X", x)
    IupSetInt(dlg, "_OLD_Y", y)

    return IUP_DEFAULT
end function

function item_resize_action_cb(Ihandle /*ih*/)
imImage image = IupGetInt(canvas, "IMAGE")
imImage new_image
integer height = im_height(image),
        width = im_width(image)
integer quality = IupConfigGetVariableInt(config, "Image", "ResizeQuality", 1) -- medium default

sequence res = IupGetParam("Resize", NULL, NULL,
                           "Width: %i[1,]\n"&
                           "Height: %i[1,]\n"&
                           "Quality: %l|low|medium|high|\n",
                           {width, height, quality})
    if res[$]=0 then
        return IUP_DEFAULT
    end if

    IupConfigSetVariableInt(config, "Image", "ResizeQuality", quality)

    new_image = imImageCreateBased(image, width, height, -1, -1)
    if new_image=NULL then
        show_file_error(IM_ERR_MEM)
        return IUP_DEFAULT
    end if

    if quality==2 then
        quality = 3 -- interpolation order can be 0, 1, and 3
    end if

    imProcessResize(image, new_image, quality)

    update_image(new_image, 1)  -- update size

    return IUP_DEFAULT
end function

function item_mirror_action_cb(Ihandle /*ih*/)
imImage image = IupGetInt(canvas, "IMAGE")
imImage new_image = imImageClone(image)
    if new_image=NULL then
        show_file_error(IM_ERR_MEM)
        return IUP_DEFAULT
    end if

    imProcessMirror(image, new_image)

    update_image(new_image, 0)

    return IUP_DEFAULT
end function

function item_flip_action_cb(Ihandle /*ih*/)
imImage image = IupGetInt(canvas, "IMAGE")
imImage new_image = imImageClone(image)
    if new_image=NULL then
        show_file_error(IM_ERR_MEM)
        return IUP_DEFAULT
    end if

    imProcessFlip(image, new_image)

    update_image(new_image, 0)

    return IUP_DEFAULT
end function

function item_rotate180_action_cb(Ihandle /*ih*/)
imImage image = IupGetInt(canvas, "IMAGE")
imImage new_image = imImageClone(image)
    if new_image=NULL then
        show_file_error(IM_ERR_MEM)
        return IUP_DEFAULT
    end if

    imProcessRotate180(image, new_image)

    update_image(new_image, 0)

    return IUP_DEFAULT
end function

function item_rotate90cw_action_cb(Ihandle /*ih*/)
imImage image = IupGetInt(canvas, "IMAGE")
imImage new_image = imImageCreateBased(image, im_height(image), im_width(image), -1, -1)
    if new_image=NULL then
        show_file_error(IM_ERR_MEM)
        return IUP_DEFAULT
    end if
    imProcessRotate90(image, new_image, 1)
    update_image(new_image, 1)  -- update size
    return IUP_DEFAULT
end function

function item_rotate90ccw_action_cb(Ihandle /*ih*/)
imImage image = IupGetInt(canvas, "IMAGE")
imImage new_image = imImageCreateBased(image, im_height(image), im_width(image), -1, -1)
    if new_image=NULL then
        show_file_error(IM_ERR_MEM)
        return IUP_DEFAULT
    end if
    imProcessRotate90(image, new_image, -1)
    update_image(new_image, 1)  -- update size
    return IUP_DEFAULT
end function

function item_negative_action_cb(Ihandle /*ih*/)
imImage image = IupGetInt(canvas, "IMAGE")
imImage new_image = imImageClone(image)
    if new_image=NULL then
        show_file_error(IM_ERR_MEM)
        return IUP_DEFAULT
    end if
    imProcessNegative(image, new_image)
    update_image(new_image, 0)
    return IUP_DEFAULT
end function

function brightcont_param_cb(Ihandle dialog, integer param_index, atom user_data)
Ihandle canvas = user_data

    if param_index==0 or param_index==1 then
        imImage image = IupGetInt(canvas, "ORIGINAL_IMAGE")
        imImage new_image = IupGetInt(canvas, "NEW_IMAGE")
        Ihandle brightness_shift_param = IupGetInt(dialog, "PARAM0")
        Ihandle contrast_factor_param = IupGetInt(dialog, "PARAM1")
        atom brightness = IupGetFloat(brightness_shift_param, "VALUE")
        atom contrast = IupGetFloat(contrast_factor_param, "VALUE")
        imProcessToneGamut(image, new_image, IM_GAMUT_BRIGHTCONT, {brightness,contrast})
        IupSetInt(canvas, "IMAGE", new_image)
        IupUpdate(canvas)
    elsif param_index!=IUP_GETPARAM_INIT then
        -- restore original configuration
        imImage image = IupGetInt(canvas, "ORIGINAL_IMAGE")
        IupSetInt(canvas, "IMAGE", image)
        IupSetInt(canvas, "ORIGINAL_IMAGE", NULL)
        IupSetInt(canvas, "NEW_IMAGE", NULL)

        if param_index==IUP_GETPARAM_BUTTON2 then  -- cancel
            IupUpdate(canvas)
        end if
    end if

    return 1
end function

function item_brightcont_action_cb(Ihandle /*ih*/)
imImage image = IupGetInt(canvas, "IMAGE")
imImage new_image = imImageClone(image)
    if new_image=NULL then
        return IUP_DEFAULT
    end if

    IupSetInt(canvas, "ORIGINAL_IMAGE", image)
    IupSetInt(canvas, "NEW_IMAGE", new_image)

    sequence res = IupGetParam("Brightness and Contrast", Icallback("brightcont_param_cb"), canvas,
                               "Brightness Shift: %r[-100,100]\n"&
                               "Contrast Factor: %r[-100,100]\n",
                               {0,0})
    if res[$]=0 then
        new_image = imImageDestroy(new_image)
        return IUP_DEFAULT
    end if
    imProcessToneGamut(image, new_image, IM_GAMUT_BRIGHTCONT, res[1..2])
    update_image(new_image, 0)
    return IUP_DEFAULT
end function


--/********************************** Main *****************************************/


procedure create_main_menu()
Ihandle sub_menu_file
Ihandle file_menu, item_exit, item_new, item_open, item_saveas
Ihandle sub_menu_edit, edit_menu, item_copy, item_print, item_pagesetup
Ihandle sub_menu_help, help_menu, item_help, item_about
Ihandle sub_menu_view, view_menu
Ihandle item_zoomin, item_zoomout, item_actualsize
Ihandle recent_menu, item_background
Ihandle sub_menu_image, image_menu

    item_new = IupMenuItem("&New\tCtrl+N", "ACTION", Icallback("item_new_action_cb"))
    IupSetAttribute(item_new, "IMAGE", "IUP_FileNew")

    item_open = IupMenuItem("&Open...\tCtrl+O", "ACTION", Icallback("item_open_action_cb"))
    IupSetAttribute(item_open, "IMAGE", "IUP_FileOpen")

    item_save = IupMenuItem("&Save\tCtrl+S", "ACTION", Icallback("item_save_action_cb"))
--  IupSetAttribute(item_save, "NAME", "ITEM_SAVE")
    IupSetAttribute(item_save, "IMAGE", "IUP_FileSave")

    item_saveas = IupMenuItem("Save &As...", "ACTION", Icallback("item_saveas_action_cb"))
--  IupSetAttribute(item_saveas, "NAME", "ITEM_SAVEAS")

    item_revert = IupMenuItem("&Revert", "ACTION", Icallback("item_revert_action_cb"))
--  IupSetAttribute(item_revert, "NAME", "ITEM_REVERT")

    item_pagesetup = IupMenuItem("Page Set&up...", "ACTION", Icallback("item_pagesetup_action_cb"))

    item_print = IupMenuItem("&Print...\tCtrl+P", "ACTION", Icallback("item_print_action_cb"))

    item_exit = IupMenuItem("E&xit", "ACTION", Icallback("item_exit_action_cb"))

    item_copy = IupMenuItem("&Copy\tCtrl+C", "ACTION", Icallback("item_copy_action_cb"))
--  IupSetAttribute(item_copy, "NAME", "ITEM_COPY")
    IupSetAttribute(item_copy, "IMAGE", "IUP_EditCopy")

    item_paste = IupMenuItem("&Paste\tCtrl+V", "ACTION", Icallback("item_paste_action_cb"))
--  IupSetAttribute(item_paste, "NAME", "ITEM_PASTE")
    IupSetAttribute(item_paste, "IMAGE", "IUP_EditPaste")

    item_zoomin = IupMenuItem("Zoom &In\tCtrl++", "ACTION", Icallback("zoomin_action_cb"))
    IupSetAttribute(item_zoomin, "IMAGE", "IUP_ZoomIn")

    item_zoomout = IupMenuItem("Zoom &Out\tCtrl+-", "ACTION", Icallback("zoomout_action_cb"))
    IupSetAttribute(item_zoomout, "IMAGE", "IUP_ZoomOut")

    item_actualsize = IupMenuItem("&Actual Size\tCtrl+0", "ACTION", Icallback("actualsize_action_cb"))
    IupSetAttribute(item_actualsize, "IMAGE", "IUP_ZoomActualSize")

    item_zoomgrid = IupMenuItem("&Zoom Grid", "ACTION", Icallback("item_zoomgrid_action_cb"))
--  IupSetAttribute(item_zoomgrid, "NAME", "ZOOMGRID")
    IupSetAttribute(item_zoomgrid, "VALUE", "ON")  -- default is ON

    item_background = IupMenuItem("&Background...", "ACTION", Icallback("item_background_action_cb"))

    item_toolbar = IupMenuItem("&Toobar", "ACTION", Icallback("item_toolbar_action_cb"))
    IupSetAttribute(item_toolbar, "VALUE", "ON")   -- default is ON

    item_toolbox = IupMenuItem("&Toobox", "ACTION", Icallback("item_toolbox_action_cb"))
--DEV
--  IupSetAttribute(item_toolbox, "NAME", "TOOLBOXMENU")
    IupSetAttribute(item_toolbox, "VALUE", "ON")   -- default is ON

    item_statusbar = IupMenuItem("&Statusbar", "ACTION", Icallback("item_statusbar_action_cb"))
    IupSetAttribute(item_statusbar, "VALUE", "ON")  -- default is ON

    item_help = IupMenuItem("&Help...", "ACTION", Icallback("item_help_action_cb"))

    item_about = IupMenuItem("&About...", "ACTION", Icallback("item_about_action_cb"))

    recent_menu = IupMenu({})

    file_menu = IupMenu({
                         item_new,
                         item_open,
                         item_save,
                         item_saveas,
                         item_revert,
                         IupSeparator(),
                         item_pagesetup,
                         item_print,
                         IupSeparator(),
                         IupSubmenu("Recent &Files", recent_menu),
                         IupSeparator(),
                         item_exit})
    edit_menu = IupMenu({
                         item_copy,
                         item_paste})
    view_menu = IupMenu({
                         item_zoomin,
                         item_zoomout,
                         item_actualsize,
                         item_zoomgrid,
                         IupSeparator(),
                         item_background,
                         IupSeparator(),
                         item_toolbar,
                         item_toolbox,
                         item_statusbar})
    image_menu = IupMenu({
                          IupMenuItem("&Resize...", "ACTION", Icallback("item_resize_action_cb")),
                          IupMenuItem("&Mirror", "ACTION", Icallback("item_mirror_action_cb")),
                          IupMenuItem("&Flip", "ACTION", Icallback("item_flip_action_cb")),
                          IupMenuItem("&Rotate 180", "ACTION", Icallback("item_rotate180_action_cb")),
                          IupMenuItem("&Rotate +90 (clock-wise)", "ACTION", Icallback("item_rotate90cw_action_cb")),
                          IupMenuItem("&Rotate -90 (counter-clock)", "ACTION", Icallback("item_rotate90ccw_action_cb")),
                          IupSeparator(),
                          IupMenuItem("&Negative", "ACTION", Icallback("item_negative_action_cb")),
                          IupMenuItem("&Brightness and Contrast...", "ACTION", Icallback("item_brightcont_action_cb"))})
    help_menu = IupMenu({
                         item_help,
                         item_about})

    IupSetCallback(file_menu, "OPEN_CB", Icallback("file_menu_open_cb"))
    IupSetCallback(edit_menu, "OPEN_CB", Icallback("edit_menu_open_cb"))

    sub_menu_file = IupSubmenu("&File", file_menu)
    sub_menu_edit = IupSubmenu("&Edit", edit_menu)
    sub_menu_view = IupSubmenu("&View", view_menu)
    sub_menu_image = IupSubmenu("&Image", image_menu)
    sub_menu_help = IupSubmenu("&Help", help_menu)

    main_menu = IupMenu({sub_menu_file,
                         sub_menu_edit,
                         sub_menu_view,
                         sub_menu_image,
                         sub_menu_help})

    -- Initialize variables from the configuration file

    IupConfigRecentInit(config, recent_menu, Icallback("config_recent_cb"), 10)

    if IupConfigGetVariableInt(config, "Canvas", "ZoomGrid", 1)=0 then
        IupSetAttribute(item_zoomgrid, "VALUE", "OFF")
    end if
    if IupConfigGetVariableInt(config, "MainWindow", "Toolbar", 1)=0 then
        IupSetAttribute(item_toolbar, "VALUE", "OFF")
    end if
    if IupConfigGetVariableInt(config, "MainWindow", "Toolbox", 1)=0 then
        IupSetAttribute(item_toolbox, "VALUE", "OFF")
    end if
    if IupConfigGetVariableInt(config, "MainWindow", "Statusbar", 1)=0 then
        IupSetAttribute(item_statusbar, "VALUE", "OFF")
    end if
end procedure

procedure create_toolbar()
Ihandle btn_copy, btn_paste, btn_new, btn_open, btn_save, btn_zoomgrid

    IupSetHandle("PaintZoomGrid", load_image_PaintZoomGrid())

    btn_new = IupButton()
    IupSetAttribute(btn_new, "IMAGE", "IUP_FileNew")
    IupSetAttribute(btn_new, "FLAT", "Yes")
    IupSetCallback(btn_new, "ACTION", Icallback("item_new_action_cb"))
    IupSetAttribute(btn_new, "TIP", "New (Ctrl+N)")
    IupSetAttribute(btn_new, "CANFOCUS", "No")

    btn_open = IupButton()
    IupSetAttribute(btn_open, "IMAGE", "IUP_FileOpen")
    IupSetAttribute(btn_open, "FLAT", "Yes")
    IupSetCallback(btn_open, "ACTION", Icallback("item_open_action_cb"))
    IupSetAttribute(btn_open, "TIP", "Open (Ctrl+O)")
    IupSetAttribute(btn_open, "CANFOCUS", "No")

    btn_save = IupButton()
    IupSetAttribute(btn_save, "IMAGE", "IUP_FileSave")
    IupSetAttribute(btn_save, "FLAT", "Yes")
    IupSetCallback(btn_save, "ACTION", Icallback("item_save_action_cb"))
    IupSetAttribute(btn_save, "TIP", "Save (Ctrl+S)")
    IupSetAttribute(btn_save, "CANFOCUS", "No")

    btn_copy = IupButton()
    IupSetAttribute(btn_copy, "IMAGE", "IUP_EditCopy")
    IupSetAttribute(btn_copy, "FLAT", "Yes")
    IupSetCallback(btn_copy, "ACTION", Icallback("item_copy_action_cb"))
    IupSetAttribute(btn_copy, "TIP", "Copy (Ctrl+C)")
    IupSetAttribute(btn_copy, "CANFOCUS", "No")

    btn_paste = IupButton()
    IupSetAttribute(btn_paste, "IMAGE", "IUP_EditPaste")
    IupSetAttribute(btn_paste, "FLAT", "Yes")
    IupSetCallback(btn_paste, "ACTION", Icallback("item_paste_action_cb"))
    IupSetAttribute(btn_paste, "TIP", "Paste (Ctrl+V)")
    IupSetAttribute(btn_paste, "CANFOCUS", "No")

    btn_zoomgrid = IupButton()
    IupSetAttribute(btn_zoomgrid, "IMAGE", "PaintZoomGrid")
    IupSetAttribute(btn_zoomgrid, "FLAT", "Yes")
    IupSetCallback(btn_zoomgrid, "ACTION", Icallback("item_zoomgrid_action_cb"))
    IupSetAttribute(btn_zoomgrid, "TIP", "Zoom Grid")
    IupSetAttribute(btn_paste, "CANFOCUS", "No")

    toolbar = IupHbox({
                       btn_new,
                       btn_open,
                       btn_save,
--                     IupSetAttributesf(IupLabel(), "SEPARATOR=VERTICAL"),
                       IupLabel(NULL, "SEPARATOR=VERTICAL"),
                       btn_copy,
                       btn_paste,
--                     IupSetAttributesf(IupLabel(), "SEPARATOR=VERTICAL"),
                       IupLabel(NULL, "SEPARATOR=VERTICAL"),
                       btn_zoomgrid})

    IupSetAttribute(toolbar, "MARGIN", "5x5")
    IupSetAttribute(toolbar, "GAP", "2")
--  IupSetAttribute(toolbar, "NAME", "TOOLBAR")

    -- Initialize variables from the configuration file

    if IupConfigGetVariableInt(config, "MainWindow", "Toolbar", 1)=0 then
        IupSetAttribute(toolbar, "FLOATING", "YES")
        IupSetAttribute(toolbar, "VISIBLE", "NO")
    end if
end procedure

procedure create_toolbox()
Ihandle gbox, tool_frame, tool_vbox

    IupSetHandle("PaintPointer", load_image_Pointer())
    IupSetHandle("PaintColorPicker", load_image_PaintColorPicker())
    IupSetHandle("PaintPencil", load_image_PaintPencil())
    IupSetHandle("PaintLine", load_image_PaintLine())
    IupSetHandle("PaintEllipse", load_image_PaintEllipse())
    IupSetHandle("PaintRect", load_image_PaintRect())
    IupSetHandle("PaintOval", load_image_PaintOval())
    IupSetHandle("PaintBox", load_image_PaintBox())
    IupSetHandle("PaintFill", load_image_PaintFill())
    IupSetHandle("PaintText", load_image_PaintText())

    gbox = IupGridBox({
                       IupToggle("", cb_tool_action, `TOOLINDEX=0, IMAGE=PaintPointer, VALUE=ON, FLAT=Yes, TIP="Pointer"`),
                       IupToggle("", cb_tool_action, `TOOLINDEX=1, IMAGE=PaintColorPicker, FLAT=Yes, TIP="Color Picker"`),
                       IupToggle("", cb_tool_action, `TOOLINDEX=2, IMAGE=PaintPencil, FLAT=Yes, TIP="Pencil"`),
                       IupToggle("", cb_tool_action, `TOOLINDEX=3, IMAGE=PaintLine, FLAT=Yes, TIP="Line"`),
                       IupToggle("", cb_tool_action, `TOOLINDEX=4, IMAGE=PaintRect, FLAT=Yes, TIP="Hollow Rectangle"`),
                       IupToggle("", cb_tool_action, `TOOLINDEX=5, IMAGE=PaintBox, FLAT=Yes, TIP="Box (Filled Rectangle)"`),
                       IupToggle("", cb_tool_action, `TOOLINDEX=6, IMAGE=PaintEllipse, FLAT=Yes, TIP="Hollow Ellipse"`),
                       IupToggle("", cb_tool_action, `TOOLINDEX=7, IMAGE=PaintOval, FLAT=Yes, TIP="Oval (Filled Ellipse)"`),
                       IupToggle("", cb_tool_action, `TOOLINDEX=8, IMAGE=PaintText, FLAT=Yes, TIP="Text"`),
                       IupToggle("", cb_tool_action, `TOOLINDEX=9, IMAGE=PaintFill, FLAT=Yes, TIP="Fill Color"`)})
    IupSetAttribute(gbox, "GAPCOL", "2")
    IupSetAttribute(gbox, "GAPLIN", "2")
    IupSetAttribute(gbox, "MARGIN", "5x10")
    IupSetAttribute(gbox, "NUMDIV", "2")

    toolcolor_btn = IupButton(NULL,Icallback("toolcolor_action_cb"), `NAME=COLOR, BGCOLOR="0 0 0", RASTERSIZE=28x21`)
    toolwidth_txt = IupText("VALUECHANGED_CB", Icallback("toolwidth_valuechanged_cb"), "SPIN=Yes, SPINMIN=1, RASTERSIZE=48x")
    toolstyle_lst = IupList("VALUECHANGED_CB", Icallback("toolstyle_valuechanged_cb"), 
                            `DROPDOWN=Yes, VALUE=1, 1="____", 2="----", 3="....", 4="-.-.", 5="-..-.."`)
    filltol_label = IupLabel("Tol.: 50%", "EXPAND=HORIZONTAL")
    filltol_val = IupValuator(NULL, "VALUECHANGED_CB", Icallback("toolfilltol_valuechanged_cb"), "RASTERSIZE=60x30, VALUE=50, MAX=100")
    toolfont_btn = IupButton("F", Icallback("toolfont_action_cb"), `NAME=FONT, RASTERSIZE=21x21, FONT="Times, Bold Italic 11"`)
    tool_frame = IupFrame(IupVbox({
                                    IupLabel("Color:", "EXPAND=HORIZONTAL"),
                                    toolcolor_btn,
                                    IupLabel("Width:", "EXPAND=HORIZONTAL"),
                                    toolwidth_txt,
                                    IupLabel("Style:", "EXPAND=HORIZONTAL"),
                                    toolstyle_lst,
                                    filltol_label,
                                    filltol_val,
                                    IupLabel("Font:", "EXPAND=HORIZONTAL"),
                                    toolfont_btn
                                  },
                                  "MARGIN=3x2, GAP=2, ALIGNMENT=ACENTER"))
    tool_vbox = IupVbox({
                         IupRadio(gbox),
                         tool_frame
                         })

    IupSetAttribute(tool_vbox, "NMARGIN", "2x2")
    IupSetAttribute(tool_vbox, "ALIGNMENT", "ACENTER")

    toolbox = IupDialog(tool_vbox)
    IupSetAttribute(toolbox, "DIALOGFRAME", "Yes")
    IupSetAttribute(toolbox, "TITLE", "Tools")
    IupSetAttribute(toolbox, "FONTSIZE", "8")
    IupSetAttribute(toolbox, "TOOLBOX", "Yes")
    IupSetCallback(toolbox, "CLOSE_CB", Icallback("toolbox_close_cb"))
    IupSetAttributeHandle(toolbox, "PARENTDIALOG", dlg)

--  IupSetAttribute(toolbox, "TOOLCOLOR", "0 0 0")
    IupSetAttribute(toolcolor_btn, "BGCOLOR", "0 0 0")
    IupSetAttribute(toolbox, "TOOLWIDTH", "1")
    IupSetAttribute(toolbox, "TOOLSTYLE", "1")
    IupSetAttribute(toolbox, "TOOLFILLTOL", "50")
    IupSetStrAttribute(toolbox, "TOOLFONT", IupGetAttribute(dlg, "FONT"))

--  IupSetInt(toolbox, "CONFIG", config)
--  IupSetInt(toolbox, "CANVAS", canvas)

--  IupSetInt(dlg, "TOOLBOX", toolbox)

    -- Initialize variables from the configuration file

    if IupConfigGetVariableInt(config, "MainWindow", "Toolbox", 1) then
        -- configure the very first time to be aligned with the main window
--      if IupConfigGetVariableStr(config, "Toolbox", "X")=0 then
        if IupConfigGetVariableInt(config, "Toolbox", "X")=0 then
            integer x = IupGetInt(canvas, "X")
            integer y = IupGetInt(canvas, "Y")
            IupConfigSetVariableInt(config, "Toolbox", "X", x)
            IupConfigSetVariableInt(config, "Toolbox", "Y", y)
        end if

        IupConfigDialogShow(config, toolbox, "Toolbox")
    end if
end procedure

procedure create_statusbar()
    zoom_lbl = IupLabel("100%", "SIZE=30x, PADDING=10x5, ALIGNMENT=ARIGHT")
    size_lbl = IupLabel("0 x 0", "SIZE=70x, PADDING=10x5, ALIGNMENT=ACENTER")
    status_lbl = IupLabel("(0, 0) = 0   0   0", "EXPAND=HORIZONTAL, PADDING=10x5")
    zoom_val = IupValuator(NULL, "VALUECHANGED_CB", Icallback("zoom_valuechanged_cb"), "VALUE=0, MIN=-6, MAX=6, RASTERSIZE=150x25")
    statusbar = IupHbox({
                         status_lbl,
                         IupLabel("", "SEPARATOR=VERTICAL"),
                         size_lbl,
                         IupLabel("", "SEPARATOR=VERTICAL"),
                         zoom_lbl,
                         IupButton(NULL, Icallback("zoomout_action_cb"),    `IMAGE=IUP_ZoomOut,        FLAT=Yes, TIP="Zoom Out (Ctrl+-)"`),
                         zoom_val,
                         IupButton(NULL, Icallback("zoomin_action_cb"),     `IMAGE=IUP_ZoomIn,         FLAT=Yes, TIP="Zoom In (Ctrl++)"`),
                         IupButton(NULL, Icallback("actualsize_action_cb"), `IMAGE=IUP_ZoomActualSize, FLAT=Yes, TIP="Actual Size (Ctrl+0)"`)})

    IupSetAttribute(statusbar, "NAME", "STATUSBAR")
    IupSetAttribute(statusbar, "ALIGNMENT", "ACENTER")

    -- Initialize variables from the configuration file

    if IupConfigGetVariableInt(config, "MainWindow", "Statusbar", 1)=0 then
        IupSetAttribute(statusbar, "FLOATING", "YES")
        IupSetAttribute(statusbar, "VISIBLE", "NO")
    end if

end procedure

procedure create_main_dialog()
Ihandle main_vbox

--  if USE_OPENGL then
        canvas = IupGLCanvas()
        IupSetAttribute(canvas, "BUFFER", "DOUBLE")
--  else
--      canvas = IupCanvas()
--  end if
--  IupSetAttribute(canvas, "NAME", "CANVAS")
    IupSetAttribute(canvas, "SCROLLBAR", "Yes")
    IupSetAttribute(canvas, "DIRTY", "NO")  -- custom attribute
    IupSetCallback(canvas, "ACTION", Icallback("canvas_action_cb"))
    IupSetCallback(canvas, "DROPFILES_CB", Icallback("dropfiles_cb"))
    IupSetCallback(canvas, "MAP_CB", Icallback("canvas_map_cb"))
    IupSetCallback(canvas, "UNMAP_CB", Icallback("canvas_unmap_cb"))
    IupSetCallback(canvas, "WHEEL_CB", Icallback("canvas_wheel_cb"))
    IupSetCallback(canvas, "RESIZE_CB", Icallback("canvas_resize_cb"))
    IupSetCallback(canvas, "MOTION_CB", Icallback("canvas_motion_cb"))
    IupSetCallback(canvas, "BUTTON_CB", Icallback("canvas_button_cb"))

    create_toolbar()
    create_statusbar()
    main_vbox = IupVbox({toolbar,
                         canvas,
                         statusbar})

    dlg = IupDialog(main_vbox)
    create_main_menu()
    IupSetAttributeHandle(dlg, "MENU", main_menu)
    IupSetAttribute(dlg, "SIZE", "HALFxHALF")
    IupSetCallback(dlg, "CLOSE_CB", Icallback("item_exit_action_cb"))
    IupSetCallback(dlg, "DROPFILES_CB", Icallback("dropfiles_cb"))
    IupSetCallback(dlg, "MOVE_CB", Icallback("main_dlg_move_cb"))

    IupSetCallback(dlg, "K_cN", Icallback("item_new_action_cb"))
    IupSetCallback(dlg, "K_cO", Icallback("item_open_action_cb"))
    IupSetCallback(dlg, "K_cS", Icallback("item_save_action_cb"))
    IupSetCallback(dlg, "K_cV", Icallback("item_paste_action_cb"))
    IupSetCallback(dlg, "K_cC", Icallback("item_copy_action_cb"))
    IupSetCallback(dlg, "K_cP", Icallback("item_print_action_cb"))
    IupSetCallback(dlg, "K_cMinus", Icallback("zoomout_action_cb"))
    IupSetCallback(dlg, "K_cPlus", Icallback("zoomin_action_cb"))
    IupSetCallback(dlg, "K_cEqual", Icallback("zoomin_action_cb"))
    IupSetCallback(dlg, "K_c0", Icallback("actualsize_action_cb"))

    -- parent for pre-defined dialogs in closed functions (IupMessage and IupAlarm)
--DEV
--  IupSetAttributeHandle(NULL, "PARENTDIALOG", dlg)

--  IupSetInt(dlg, "CONFIG", config)

--  return dlg
--end function
end procedure


sequence cl

    IupOpen()

    IupImageLibOpen()
--  if USE_OPENGL then
        IupGLCanvasOpen()
--  end if
    if USE_CONTEXTPLUS then
        cdInitContextPlus()
    end if

    config = IupConfig()
    IupSetAttribute(config, "APP_NAME", "simple_paint")
    {} = IupConfigLoad(config)

    clipboard = IupClipboard()

    create_main_dialog()

    -- show the dialog at the last position, with the last size
    IupConfigDialogShow(config, dlg, "MainWindow")

    -- create and show the toolbox
    create_toolbox()

    -- open a file from the command line (allow file association in Windows)
    cl = command_line()
    if length(cl)>2 then
        string filename = cl[3]
        open_file(filename)
    end if

    -- initialize the current file, if not already loaded
    check_new_file()

    IupMainLoop()

    IupClose()


